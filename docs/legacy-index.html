<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sistema de Gestión de Territorios - Autosustentable</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Librerías para Visualización y PDF -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- CSS Styles -->
    <style>
      :root {
        /* Paleta de Colores Profesional */

        /* Colores Primarios - Azul Corporativo */
        --primary: #1e40af;
        --primary-dark: #1e3a8a;
        --primary-light: #3b82f6;
        --primary-lighter: #93c5fd;
        --primary-lightest: #dbeafe;

        /* Colores Secundarios - Índigo Elegante */
        --secondary: #4f46e5;
        --secondary-dark: #3730a3;
        --secondary-light: #6366f1;
        --secondary-lighter: #a5b4fc;
        --secondary-lightest: #e0e7ff;

        /* Colores de Estado */
        --success: #10b981;
        --success-dark: #059669;
        --success-light: #34d399;
        --success-bg: #d1fae5;

        --warning: #f59e0b;
        --warning-dark: #d97706;
        --warning-light: #fbbf24;
        --warning-bg: #fef3c7;

        --error: #ef4444;
        --error-dark: #dc2626;
        --error-light: #f87171;
        --error-bg: #fee2e2;

        --info: #06b6d4;
        --info-dark: #0891b2;
        --info-light: #22d3ee;
        --info-bg: #cffafe;

        /* Grises Profesionales */
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;

        /* Fondos Adaptativos */
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --bg-surface: rgba(255, 255, 255, 0.95);
        --bg-overlay: rgba(15, 23, 42, 0.8);

        /* Fondos Oscuros para Contraste */
        --bg-dark-1: #0f172a;
        --bg-dark-2: #1e293b;
        --bg-dark-3: #334155;

        /* Glassmorphism */
        --glass: rgba(255, 255, 255, 0.12);
        --glass-border: rgba(255, 255, 255, 0.15);
        --stroke: rgba(226, 232, 240, 0.2);

        /* Texto */
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --text-muted: #64748b;
        --text-light: #94a3b8;
        --text-inverse: #ffffff;

        /* Para fondos oscuros */
        --text-dark-primary: #f8fafc;
        --text-dark-secondary: #cbd5e1;
        --text-dark-muted: #94a3b8;

        /* Sombras Profesionales */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);

        /* Espaciado y Geometría */
        --radius-sm: 6px;
        --radius: 12px;
        --radius-lg: 16px;
        --radius-xl: 20px;
        --radius-2xl: 24px;
        --pad: 16px;
        --gap: 16px;

        /* Transiciones Suaves */
        --transition-fast: 150ms ease-in-out;
        --transition-normal: 250ms ease-in-out;
        --transition-slow: 350ms ease-in-out;

        /* Colores de Territorio (para la aplicación específica) */
        --territorio-disponible: var(--success);
        --territorio-asignado: var(--warning);
        --territorio-completado: var(--primary);
        --territorio-vencido: var(--error);
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        background: radial-gradient(
            ellipse 1200px 800px at 50% -20%,
            rgba(30, 64, 175, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            ellipse 1000px 600px at 80% 100%,
            rgba(79, 70, 229, 0.1) 0%,
            transparent 50%
          ),
          linear-gradient(
            135deg,
            var(--bg-secondary) 0%,
            var(--gray-50) 50%,
            var(--bg-tertiary) 100%
          );
        color: var(--text-primary);
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        font-feature-settings: "cv02", "cv03", "cv04", "cv11";
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      main {
        width: 100%;
        max-width: 1400px;
        padding: 32px 24px;
      }

      h1 {
        text-align: center;
        margin: 0 0 24px;
        font-size: clamp(2rem, 3vw + 1rem, 3rem);
        font-weight: 700;
        color: var(--text-primary);
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.02em;
      }

      h2 {
        margin-top: 0;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1.5rem;
        line-height: 1.3;
      }

      h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary);
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        line-height: 1.4;
      }

      .mode-switch {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .tab {
        appearance: none;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 12px 20px;
        background: var(--bg-primary);
        color: var(--text-secondary);
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all var(--transition-normal);
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
      }

      .tab::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        opacity: 0;
        transition: opacity var(--transition-normal);
        z-index: -1;
      }

      .tab:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-lighter);
      }

      .tab.active {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: var(--text-inverse);
        border-color: var(--primary);
        box-shadow: var(--shadow-lg);
        transform: translateY(-1px);
      }

      .app {
        display: flex;
        flex-direction: column;
        gap: var(--gap);
        padding: clamp(20px, 2vw + 12px, 32px);
        border-radius: var(--radius-2xl);
        background: var(--bg-surface);
        border: 1px solid var(--gray-200);
        backdrop-filter: blur(20px);
        box-shadow: var(--shadow-2xl);
        position: relative;
        overflow: hidden;
      }

      .app::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(
          90deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
      }

      .card {
        background: var(--bg-primary);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-md);
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: var(--gray-300);
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          var(--primary-light) 0%,
          var(--secondary-light) 100%
        );
        opacity: 0;
        transition: opacity var(--transition-normal);
      }

      .card:hover::before {
        opacity: 1;
      }

      .grid-2 {
        display: grid;
        gap: var(--gap);
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .grid-3 {
        display: grid;
        gap: var(--gap);
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .grid-4 {
        display: grid;
        gap: var(--gap);
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
      @media (max-width: 768px) {
        .grid-2,
        .grid-3,
        .grid-4 {
          grid-template-columns: 1fr;
        }
      }

      label {
        display: block;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: 0.01em;
      }

      select,
      input,
      textarea {
        width: 100%;
        padding: 14px 16px;
        border-radius: var(--radius-lg);
        border: 2px solid var(--gray-200);
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 1rem;
        font-family: inherit;
        transition: all var(--transition-normal);
        box-shadow: var(--shadow-sm);
      }

      select:hover,
      input:hover,
      textarea:hover {
        border-color: var(--gray-300);
      }

      select:focus,
      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        transform: translateY(-1px);
      }

      select:disabled,
      input:disabled,
      textarea:disabled {
        background: var(--gray-50);
        color: var(--gray-400);
        cursor: not-allowed;
      }
      select option {
        color: #000;
        background: #fff;
      }
      .line-space {
        height: 12px;
      }

      .btn {
        appearance: none;
        border: none;
        border-radius: var(--radius-lg);
        padding: 14px 20px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.95rem;
        font-family: inherit;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: var(--text-inverse);
        transition: all var(--transition-normal);
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
        min-height: 48px;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left var(--transition-slow);
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
        background: linear-gradient(
          135deg,
          var(--primary-light) 0%,
          var(--primary) 100%
        );
      }

      .btn:active {
        transform: translateY(0px);
        box-shadow: var(--shadow-md);
      }

      .btn.secondary {
        background: linear-gradient(
          135deg,
          var(--gray-600) 0%,
          var(--gray-700) 100%
        );
        color: var(--text-inverse);
      }

      .btn.secondary:hover {
        background: linear-gradient(
          135deg,
          var(--gray-500) 0%,
          var(--gray-600) 100%
        );
      }

      .btn.ghost {
        background: transparent;
        border: 2px solid var(--gray-300);
        color: var(--text-secondary);
        box-shadow: none;
      }

      .btn.ghost:hover {
        background: var(--gray-50);
        border-color: var(--primary);
        color: var(--primary);
      }

      .btn.ok {
        background: linear-gradient(
          135deg,
          var(--success) 0%,
          var(--success-dark) 100%
        );
        color: var(--text-inverse);
      }

      .btn.ok:hover {
        background: linear-gradient(
          135deg,
          var(--success-light) 0%,
          var(--success) 100%
        );
      }

      .btn.err {
        background: linear-gradient(
          135deg,
          var(--error) 0%,
          var(--error-dark) 100%
        );
        color: var(--text-inverse);
      }

      .btn.err:hover {
        background: linear-gradient(
          135deg,
          var(--error-light) 0%,
          var(--error) 100%
        );
      }

      .btn.warn {
        background: linear-gradient(
          135deg,
          var(--warning) 0%,
          var(--warning-dark) 100%
        );
        color: var(--gray-900);
      }

      .btn.warn:hover {
        background: linear-gradient(
          135deg,
          var(--warning-light) 0%,
          var(--warning) 100%
        );
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: var(--shadow-sm);
      }

      .btn:disabled:hover {
        transform: none;
        box-shadow: var(--shadow-sm);
      }

      .btn-sm {
        padding: 10px 16px;
        font-size: 0.875rem;
        min-height: 40px;
      }

      .btn-lg {
        padding: 18px 28px;
        font-size: 1.1rem;
        min-height: 56px;
      }

      .hint {
        color: var(--muted);
        font-size: 0.95rem;
        opacity: 0.95;
      }

      /* Professional Login Styles */
      .login-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: white;
      }
      .login-subtitle {
        color: var(--muted);
        font-size: 0.9rem;
        margin: 8px 0 0 0;
        font-weight: 400;
      }
      .form-input-professional {
        transition: all 0.3s ease;
        padding-left: 12px;
      }
      .form-input-professional:focus {
        box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
        transform: translateY(-1px);
      }
      .field-hint {
        color: var(--muted);
        font-size: 0.8rem;
        margin-top: 4px;
        display: block;
      }
      .password-container {
        position: relative;
      }
      .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: color 0.2s;
      }
      .password-toggle:hover {
        color: var(--accent-2);
      }
      .error-message {
        color: var(--err);
        font-size: 0.9rem;
        padding: 8px 12px;
        background: rgba(251, 113, 133, 0.1);
        border: 1px solid rgba(251, 113, 133, 0.2);
        border-radius: 8px;
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .login-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }
      .btn-loading {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        margin-bottom: 8px;
      }
      label svg {
        opacity: 0.7;
      }

      /* Professional Navigation Styles */
      .mode-switch .tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 18px;
        font-size: 0.95rem;
      }
      .mode-switch .tab svg {
        opacity: 0.8;
      }
      .mode-switch .tab.active svg {
        opacity: 1;
      }
      .panel-nav .tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        font-size: 0.9rem;
        white-space: nowrap;
      }
      .panel-nav .tab svg {
        opacity: 0.7;
        flex-shrink: 0;
      }
      .panel-nav .tab.active svg {
        opacity: 1;
      }

      /* Configuration Panel Styles */
      .config-header {
        background: linear-gradient(
          135deg,
          rgba(167, 139, 250, 0.1),
          rgba(96, 165, 250, 0.1)
        );
        border: 1px solid rgba(167, 139, 250, 0.2);
      }
      .config-title {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }
      .config-title svg {
        color: var(--accent);
      }
      .config-subtitle {
        color: var(--muted);
        font-size: 0.9rem;
        margin: 0;
      }
      .config-tabs {
        margin-top: 16px;
      }
      .config-section {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }

      /* Professional Form Styling */
      .form-group {
        margin-bottom: 20px;
      }
      .form-group:last-child {
        margin-bottom: 0;
      }

      /* Enhanced Card Styling */
      .card {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }
      .card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      /* KPI Cards Enhancement */
      .kpi-card {
        text-align: center;
        padding: 20px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        border: 1px solid var(--stroke);
        border-radius: 12px;
        transition: all 0.3s ease;
      }
      .kpi-card:hover {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.15),
          rgba(255, 255, 255, 0.08)
        );
        transform: translateY(-2px);
      }
      .kpi-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--accent-2);
        margin-bottom: 8px;
      }
      .kpi-label {
        color: var(--muted);
        font-size: 0.9rem;
        font-weight: 500;
      }
      .success {
        color: var(--ok);
      }
      .error {
        color: var(--err);
      }
      .warning {
        color: var(--warn);
      }

      .lista-territorios {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .lista-territorios button {
        min-width: 36px;
        padding: 8px 10px;
        border: 1px solid var(--stroke);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .lista-territorios button.seleccionado {
        background: var(--accent);
        color: #0b1020;
        transform: scale(1.05);
      }
      .lista-territorios button.asignado {
        background: var(--warn);
        color: #2b1f01;
      }
      .lista-territorios button.completado {
        background: var(--ok);
        color: #06221a;
      }

      .manzanas-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .manzanas-group h4 {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--accent-2);
      }
      .lista-territorios.manzanas button.sel {
        outline: 2px solid var(--accent-2);
        outline-offset: 2px;
      }
      .lista-territorios.manzanas button.done {
        background: var(--ok);
        color: #06221a;
      }
      .lista-territorios.manzanas button.assigned {
        background: var(--warn);
        color: #2b1f01;
      }
      .lista-territorios.manzanas button.disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .table-wrap {
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.06);
        max-height: 60vh;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      th,
      td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.18);
        padding: 10px;
        text-align: left;
        white-space: nowrap;
      }

      td.address-cell,
      td.comments-cell,
      td.name-cell {
        white-space: normal;
        word-break: break-word;
        overflow-wrap: break-word;
        word-wrap: break-word;
        max-width: 200px;
      }

      thead {
        background: rgba(255, 255, 255, 0.14);
        position: sticky;
        top: 0;
        z-index: 1;
        backdrop-filter: blur(4px);
      }

      .asig-list {
        display: grid;
        gap: 14px;
        margin-top: 10px;
      }
      .asig-card {
        border: 1px solid var(--stroke);
        border-radius: 14px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.08);
      }
      .asig-head {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
      }
      .asig-title {
        font-weight: 700;
        font-size: 1.1rem;
      }
      .progress {
        font-size: 0.95rem;
        color: var(--muted);
      }
      .manzanas-list {
        font-size: 0.9em;
        color: var(--muted);
      }

      footer {
        text-align: center;
        margin-top: 20px;
        opacity: 0.9;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .hidden {
        display: none;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }

      dialog {
        border: none;
        border-radius: 16px;
        max-width: min(820px, 94vw);
        background: linear-gradient(180deg, #2c3e50, #1e293b);
        color: var(--text);
        padding: 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        border: 1px solid var(--stroke);
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.2s ease-out, transform 0.2s ease-out,
          display 0.2s allow-discrete;
      }
      dialog[open] {
        opacity: 1;
        transform: scale(1);
      }
      @starting-style {
        dialog[open] {
          opacity: 0;
          transform: scale(0.95);
        }
      }
      dialog::backdrop {
        background: rgba(2, 6, 23, 0.6);
        backdrop-filter: blur(4px);
        opacity: 0;
        transition: opacity 0.2s ease-out, display 0.2s allow-discrete;
      }
      dialog[open]::backdrop {
        opacity: 1;
      }
      @starting-style {
        dialog[open]::backdrop {
          opacity: 0;
        }
      }

      .modal-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 14px 16px;
        border-bottom: 1px solid var(--stroke);
      }
      .modal-body {
        padding: 14px 16px;
        max-height: 70vh;
        overflow: auto;
      }

      #loadingIndicator {
        text-align: center;
        padding: 20px;
        font-size: 1.2rem;
      }

      .panel-nav {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        border-bottom: 1px solid var(--stroke);
        padding-bottom: 8px;
        flex-wrap: wrap;
      }

      .kpi-card {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 20px;
        text-align: center;
        transition: transform 0.2s;
      }
      .kpi-card:hover {
        transform: translateY(-2px);
      }
      .kpi-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--accent-2);
        line-height: 1;
      }
      .kpi-label {
        font-size: 1rem;
        color: var(--muted);
        margin-top: 8px;
      }
      .chart-container {
        position: relative;
        height: 300px;
        margin: auto;
        max-width: 100%;
      }

      .hermanos-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .hermano-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        transition: background 0.2s;
      }
      .hermano-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .edit-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        transition: background 0.2s;
      }
      .edit-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .edit-btn svg {
        width: 20px;
        height: 20px;
        stroke: var(--muted);
        transition: stroke 0.2s;
      }
      .edit-btn:hover svg {
        stroke: var(--accent-2);
      }

      .ai-suggestion {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 12px;
        margin: 10px 0;
        border-left: 4px solid var(--accent-2);
      }

      .config-section {
        margin-bottom: 24px;
        padding: 16px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--stroke);
      }

      .import-zone {
        border: 2px dashed var(--stroke);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        background: rgba(255, 255, 255, 0.02);
        transition: all 0.3s;
        cursor: pointer;
      }
      .import-zone:hover {
        border-color: var(--accent-2);
        background: rgba(96, 165, 250, 0.1);
      }
      .import-zone.dragover {
        border-color: var(--accent);
        background: rgba(167, 139, 250, 0.1);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin: 16px 0;
      }

      .notification {
        position: fixed;
        top: 24px;
        right: 24px;
        padding: 16px 20px;
        border-radius: var(--radius-lg);
        color: var(--text-inverse);
        z-index: 9999;
        transform: translateX(120%);
        transition: all var(--transition-normal);
        font-weight: 600;
        font-size: 0.95rem;
        box-shadow: var(--shadow-xl);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        min-width: 300px;
        max-width: 400px;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background: linear-gradient(
          135deg,
          var(--success) 0%,
          var(--success-dark) 100%
        );
        border-color: rgba(16, 185, 129, 0.2);
      }

      .notification.error {
        background: linear-gradient(
          135deg,
          var(--error) 0%,
          var(--error-dark) 100%
        );
        border-color: rgba(239, 68, 68, 0.2);
      }

      .notification.warning {
        background: linear-gradient(
          135deg,
          var(--warning) 0%,
          var(--warning-dark) 100%
        );
        color: var(--gray-900);
        border-color: rgba(245, 158, 11, 0.2);
      }

      .notification.info {
        background: linear-gradient(
          135deg,
          var(--info) 0%,
          var(--info-dark) 100%
        );
        border-color: rgba(6, 182, 212, 0.2);
      }

      @media (max-width: 640px) {
        .card .row {
          flex-direction: column;
          align-items: stretch;
        }
        .card .row > .btn,
        .card .row > button,
        .card .row > input {
          width: 100%;
        }
        .modal-body {
          padding: 12px;
        }
        h1 {
          font-size: 1.5rem;
        }
        .kpi-value {
          font-size: 2rem;
        }
      }

      /* Login Screen Styles - Paleta Profesional */
      .login-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            ellipse at top left,
            rgba(30, 64, 175, 0.3) 0%,
            transparent 50%
          ),
          radial-gradient(
            ellipse at bottom right,
            rgba(79, 70, 229, 0.2) 0%,
            transparent 50%
          ),
          linear-gradient(
            135deg,
            var(--bg-secondary) 0%,
            var(--gray-100) 50%,
            var(--primary-lightest) 100%
          );
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(2px);
      }

      .login-container {
        background: var(--bg-surface);
        backdrop-filter: blur(20px);
        border-radius: var(--radius-2xl);
        padding: 3rem;
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-2xl);
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .login-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(
          90deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .login-header {
        text-align: center;
        margin-bottom: 2.5rem;
      }

      .login-logo {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 90px;
        height: 90px;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        border-radius: 50%;
        margin-bottom: 1.5rem;
        color: var(--text-inverse);
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
      }

      .login-logo::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          transparent 0%,
          rgba(255, 255, 255, 0.1) 50%,
          transparent 100%
        );
        transform: translateX(-100%);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        50% {
          transform: translateX(100%);
        }
        100% {
          transform: translateX(-100%);
        }
      }

      .login-header h2 {
        margin: 0 0 0.75rem;
        color: var(--text-primary);
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.01em;
      }

      .login-header p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 1.05rem;
        font-weight: 500;
      }

      .login-options {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .login-option {
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-xl);
        overflow: hidden;
        transition: all var(--transition-normal);
        background: var(--bg-primary);
        backdrop-filter: blur(15px);
        box-shadow: var(--shadow-md);
        position: relative;
      }

      .login-option::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          var(--primary-lightest) 0%,
          var(--secondary-lightest) 100%
        );
        opacity: 0;
        transition: opacity var(--transition-normal);
        pointer-events: none;
      }

      .login-option:hover {
        border-color: var(--primary-light);
        transform: translateY(-3px);
        box-shadow: var(--shadow-xl);
      }

      .login-option:hover::before {
        opacity: 0.3;
      }

      .login-option.active {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.15);
        background: var(--bg-primary);
      }

      .login-option.active::before {
        opacity: 0.1;
      }

      .option-header {
        display: flex;
        align-items: center;
        padding: 1.5rem;
        cursor: pointer;
        transition: all var(--transition-normal);
        position: relative;
        z-index: 1;
      }

      .option-header:hover {
        background: rgba(30, 64, 175, 0.03);
      }

      .option-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 70px;
        height: 70px;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        border-radius: var(--radius-lg);
        color: var(--text-inverse);
        margin-right: 1.25rem;
        flex-shrink: 0;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
      }

      .option-icon::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          transparent 0%,
          rgba(255, 255, 255, 0.15) 50%,
          transparent 100%
        );
        transform: translateX(-100%);
        transition: transform var(--transition-slow);
      }

      .login-option:hover .option-icon::before {
        transform: translateX(100%);
      }

      .option-content {
        flex: 1;
      }

      .option-content h3 {
        margin: 0 0 0.5rem;
        color: var(--text-primary);
        font-size: 1.25rem;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .option-content p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.95rem;
        font-weight: 500;
        line-height: 1.4;
      }

      .option-arrow {
        color: var(--gray-400);
        transition: all var(--transition-normal);
        margin-left: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--gray-100);
      }

      .login-option:hover .option-arrow {
        background: var(--primary-lightest);
        color: var(--primary);
      }

      .login-option.active .option-arrow {
        transform: rotate(180deg);
        color: var(--primary);
        background: var(--primary-lightest);
      }

      .option-form {
        padding: 0 1.5rem 1.5rem;
        border-top: 1px solid var(--gray-200);
        background: var(--bg-secondary);
        animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }

      .option-form::before {
        content: "";
        position: absolute;
        top: 0;
        left: 1.5rem;
        right: 1.5rem;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          var(--primary-light) 50%,
          transparent 100%
        );
      }

      .option-form.hidden {
        display: none;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-15px);
          max-height: 0;
        }
        to {
          opacity: 1;
          transform: translateY(0);
          max-height: 500px;
        }
      }

      .form-group {
        margin-bottom: 1.75rem;
      }

      .login-screen .form-group label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
      }

      .login-screen .form-group input {
        width: 100%;
        padding: 1rem 1.25rem;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        font-size: 1rem;
        font-family: inherit;
        font-weight: 500;
        transition: all var(--transition-normal);
        background: var(--bg-primary);
        color: var(--text-primary);
        box-shadow: var(--shadow-sm);
      }

      .login-screen .form-group input:hover {
        border-color: var(--gray-300);
        box-shadow: var(--shadow-md);
      }

      .login-screen .form-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
        transform: translateY(-1px);
      }

      .password-container {
        position: relative;
      }

      .password-toggle {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 6px;
        transition: all 0.2s ease;
      }

      .password-toggle:hover {
        color: #374151;
        background: rgba(0, 0, 0, 0.05);
      }

      .conductor-selector label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 1rem;
        font-size: 0.875rem;
      }

      .conductor-list {
        display: grid;
        gap: 0.875rem;
        max-height: 320px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--gray-300) transparent;
      }

      .conductor-list::-webkit-scrollbar {
        width: 6px;
      }

      .conductor-list::-webkit-scrollbar-track {
        background: transparent;
      }

      .conductor-list::-webkit-scrollbar-thumb {
        background: var(--gray-300);
        border-radius: 3px;
      }

      .conductor-item {
        display: flex;
        align-items: center;
        padding: 1.25rem;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all var(--transition-normal);
        background: var(--bg-primary);
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
      }

      .conductor-item::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          var(--primary-lightest),
          transparent
        );
        transition: left var(--transition-normal);
      }

      .conductor-item:hover {
        border-color: var(--primary);
        background: var(--primary-lightest);
        transform: translateX(6px);
        box-shadow: var(--shadow-md);
      }

      .conductor-item:hover::before {
        left: 100%;
      }

      .conductor-item.selected {
        border-color: var(--primary);
        background: var(--primary-lightest);
        box-shadow: var(--shadow-lg);
      }

      .conductor-avatar {
        width: 48px;
        height: 48px;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-inverse);
        font-weight: 700;
        margin-right: 1rem;
        flex-shrink: 0;
        box-shadow: var(--shadow-md);
        font-size: 0.9rem;
      }

      .conductor-info {
        flex: 1;
        min-width: 0;
      }

      .conductor-name {
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.375rem;
        font-size: 1.05rem;
        line-height: 1.3;
      }

      .conductor-details {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-weight: 500;
      }

      .login-screen .btn.full-width {
        width: 100%;
        margin-top: 1rem;
        padding: 0.875rem;
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        min-height: 48px;
      }

      .login-screen .error-message {
        background: var(--error-bg);
        color: var(--error-dark);
        padding: 1rem 1.25rem;
        border-radius: var(--radius-lg);
        margin-bottom: 1.25rem;
        border: 2px solid var(--error-light);
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        box-shadow: var(--shadow-sm);
      }

      .login-screen .success-message {
        background: var(--success-bg);
        color: var(--success-dark);
        padding: 1rem 1.25rem;
        border-radius: var(--radius-lg);
        margin-bottom: 1.25rem;
        border: 2px solid var(--success-light);
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        box-shadow: var(--shadow-sm);
      }
    </style>
  </head>
  <body>
    <main>
      <div id="congregacion-header" class="text-center mb-4">
        <h1 id="congregacion-nombre">Sistema de Gestión de Territorios</h1>
        <p id="congregacion-info" class="hint"></p>
      </div>

      <!-- Pantalla de Login Inicial -->
      <div id="login-screen" class="login-screen">
        <div class="login-container">
          <div class="login-header">
            <div class="login-logo">
              <svg
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 1L21 9v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9l9-8z" />
                <polyline points="9,22 9,12 15,12 15,22" />
              </svg>
            </div>
            <h2>Acceso al Sistema</h2>
            <p>Selecciona tu tipo de usuario</p>
          </div>

          <div class="login-options">
            <!-- Opción Administrador -->
            <div class="login-option" id="admin-option">
              <div class="option-header" data-option="admin">
                <div class="option-icon">
                  <svg
                    width="32"
                    height="32"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                  </svg>
                </div>
                <div class="option-content">
                  <h3>Administrador</h3>
                  <p>Gestión completa del sistema</p>
                </div>
                <div class="option-arrow">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="6,9 12,15 18,9" />
                  </svg>
                </div>
              </div>

              <div class="option-form hidden" id="admin-form">
                <form id="adminLoginForm">
                  <div class="form-group">
                    <label for="adminPhone">
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                        />
                      </svg>
                      Usuario (Celular)
                    </label>
                    <input
                      type="tel"
                      id="adminPhone"
                      placeholder="Ej: 0994749286"
                      required
                    />
                  </div>

                  <div class="form-group">
                    <label for="adminPassword">
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <rect
                          x="3"
                          y="11"
                          width="18"
                          height="11"
                          rx="2"
                          ry="2"
                        />
                        <circle cx="12" cy="16" r="1" />
                        <path d="m7 11V7a5 5 0 0 1 10 0v4" />
                      </svg>
                      Contraseña
                    </label>
                    <div class="password-container">
                      <input
                        type="password"
                        id="adminPassword"
                        placeholder="Contraseña de administrador"
                        required
                      />
                      <button
                        type="button"
                        id="toggleAdminPassword"
                        class="password-toggle"
                      >
                        <svg
                          id="adminEyeIcon"
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path
                            d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                          />
                          <circle cx="12" cy="12" r="3" />
                        </svg>
                      </button>
                    </div>
                  </div>

                  <div id="adminError" class="error-message hidden"></div>

                  <button
                    type="submit"
                    class="btn ok full-width"
                    id="adminLoginBtn"
                  >
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="m9 18 6-6-6-6" />
                    </svg>
                    Acceder como Administrador
                  </button>
                </form>
              </div>
            </div>

            <!-- Opción Conductor -->
            <div class="login-option" id="conductor-option">
              <div class="option-header" data-option="conductor">
                <div class="option-icon">
                  <svg
                    width="32"
                    height="32"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5Z"
                    />
                    <path d="M12 5L8 21l4-7 4 7-4-16" />
                  </svg>
                </div>
                <div class="option-content">
                  <h3>Conductor</h3>
                  <p>Acceso a asignaciones de territorio</p>
                </div>
                <div class="option-arrow">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="6,9 12,15 18,9" />
                  </svg>
                </div>
              </div>

              <div class="option-form hidden" id="conductor-form">
                <div class="conductor-selector">
                  <label>Selecciona tu nombre:</label>
                  <div id="conductorList" class="conductor-list">
                    <!-- Lista de conductores se carga dinámicamente -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Aplicación Principal (se muestra después del login) -->
      <div id="app-container" class="hidden">
        <section class="app" role="region" aria-label="Aplicación Conductores">
          <!-- ======================= -->
          <!-- VISTA MODO CONFIGURACIÓN -->
          <!-- ======================= -->
          <div id="viewConfiguracion" class="hidden">
            <nav class="panel-nav">
              <button class="tab active" data-panel="congregacion">
                Congregación
              </button>
              <button class="tab" data-panel="territorios-config">
                Territorios
              </button>
              <button class="tab" data-panel="usuarios-config">Usuarios</button>
              <button class="tab" data-panel="telefonos-config">
                Base Telefónica
              </button>
              <button class="tab" data-panel="sistema-config">Sistema</button>
            </nav>

            <div id="config-content">
              <!-- Panel Congregación -->
              <div id="panel-congregacion">
                <div class="config-section">
                  <h2>Información de la Congregación</h2>
                  <form id="congregacion-form" class="grid-2">
                    <div>
                      <label for="config-congregacion-nombre"
                        >Nombre de la Congregación</label
                      >
                      <input
                        type="text"
                        id="config-congregacion-nombre"
                        placeholder="Ej: Congregación Central"
                      />
                    </div>
                    <div>
                      <label for="config-congregacion-ciudad">Ciudad</label>
                      <input
                        type="text"
                        id="config-congregacion-ciudad"
                        placeholder="Ej: Lima"
                      />
                    </div>
                    <div>
                      <label for="config-congregacion-pais">País</label>
                      <input
                        type="text"
                        id="config-congregacion-pais"
                        placeholder="Ej: Perú"
                      />
                    </div>
                    <div>
                      <label for="config-coordinador"
                        >Coordinador de Territorio</label
                      >
                      <input
                        type="text"
                        id="config-coordinador"
                        placeholder="Nombre completo"
                      />
                    </div>
                    <div class="col-span-2">
                      <button type="submit" class="btn ok">
                        Guardar Información
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Panel Territorios Config -->
              <div id="panel-territorios-config" class="hidden">
                <div class="config-section">
                  <h2>Configuración de Territorios</h2>
                  <div class="grid-2">
                    <div>
                      <label for="config-total-territorios"
                        >Número Total de Territorios</label
                      >
                      <input
                        type="number"
                        id="config-total-territorios"
                        min="1"
                        max="100"
                        value="22"
                      />
                      <button
                        id="btnActualizarTerritorios"
                        class="btn secondary mt-2"
                      >
                        Actualizar Territorios
                      </button>
                    </div>
                    <div>
                      <h3>Vista Previa de Territorios</h3>
                      <div
                        id="territorios-preview"
                        class="lista-territorios"
                      ></div>
                    </div>
                  </div>
                  <div class="mt-4">
                    <h3>Configurar Manzanas por Territorio</h3>
                    <div
                      id="manzanas-config-container"
                      class="grid-4 gap-2"
                    ></div>
                    <button id="btnGuardarManzanas" class="btn ok mt-4">
                      Guardar Configuración de Manzanas
                    </button>
                  </div>
                </div>
              </div>

              <!-- Panel Usuarios Config -->
              <div id="panel-usuarios-config" class="hidden">
                <div class="config-section">
                  <h2>Gestión de Usuarios</h2>
                  <div class="grid-2">
                    <div>
                      <h3>Conductores</h3>
                      <div class="row">
                        <input
                          type="text"
                          id="config-nuevo-conductor"
                          placeholder="Nombre completo"
                          class="flex-grow"
                        />
                        <button id="btnAddConductor" class="btn ok">
                          Añadir
                        </button>
                      </div>
                      <div
                        id="config-conductores-list"
                        class="hermanos-list mt-4"
                      ></div>
                    </div>
                    <div>
                      <h3>Publicadores</h3>
                      <div class="row">
                        <input
                          type="text"
                          id="config-nuevo-publicador"
                          placeholder="Nombre completo"
                          class="flex-grow"
                        />
                        <button id="btnAddPublicador" class="btn ok">
                          Añadir
                        </button>
                      </div>
                      <div
                        id="config-publicadores-list"
                        class="hermanos-list mt-4"
                      ></div>
                    </div>
                  </div>
                  <div class="mt-4">
                    <button id="btnImportarUsuarios" class="btn secondary">
                      Importar desde CSV
                    </button>
                    <button id="btnExportarUsuarios" class="btn">
                      Exportar Usuarios
                    </button>
                  </div>
                </div>
              </div>

              <!-- Panel Teléfonos Config -->
              <div id="panel-telefonos-config" class="hidden">
                <div class="config-section">
                  <h2>Base de Datos Telefónica</h2>

                  <!-- Estadísticas -->
                  <div class="stats-grid">
                    <div class="kpi-card">
                      <div id="total-registros" class="kpi-value">0</div>
                      <div class="kpi-label">Total Registros</div>
                    </div>
                    <div class="kpi-card">
                      <div id="registros-activos" class="kpi-value">0</div>
                      <div class="kpi-label">Activos</div>
                    </div>
                    <div class="kpi-card">
                      <div id="registros-duplicados" class="kpi-value">0</div>
                      <div class="kpi-label">Duplicados</div>
                    </div>
                  </div>

                  <!-- Importación -->
                  <div class="import-zone" id="import-telefonos-zone">
                    <input
                      type="file"
                      id="file-import-telefonos"
                      accept=".csv,.xlsx,.xls"
                      class="hidden"
                    />
                    <div>
                      <svg
                        class="mx-auto h-12 w-12 text-gray-400"
                        stroke="currentColor"
                        fill="none"
                        viewBox="0 0 48 48"
                      >
                        <path
                          d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                      <p>
                        Haz clic aquí o arrastra archivos CSV/Excel para
                        importar números telefónicos
                      </p>
                      <p class="text-sm text-gray-500">
                        Formato requerido: Nombre, Dirección, Teléfono
                      </p>
                    </div>
                  </div>

                  <!-- Acciones -->
                  <div class="row mt-4">
                    <button id="btnAddRegistroManual" class="btn secondary">
                      Añadir Manualmente
                    </button>
                    <button id="btnLimpiarDuplicadosConfig" class="btn warn">
                      Limpiar Duplicados
                    </button>
                    <button id="btnExportarTelefonos" class="btn">
                      Exportar
                    </button>
                    <button id="btnResetTelefonos" class="btn err">
                      Resetear Base
                    </button>
                  </div>

                  <!-- Filtros y búsqueda -->
                  <div class="grid-3 mt-4">
                    <input
                      type="text"
                      id="filtro-nombre-config"
                      placeholder="Buscar por nombre"
                    />
                    <input
                      type="text"
                      id="filtro-telefono-config"
                      placeholder="Buscar por teléfono"
                    />
                    <select id="filtro-estado-config">
                      <option value="">Todos los estados</option>
                    </select>
                  </div>

                  <!-- Tabla -->
                  <div class="table-wrap mt-4">
                    <table id="tabla-telefonos-config">
                      <thead>
                        <tr>
                          <th>Nombre</th>
                          <th>Dirección</th>
                          <th>Teléfono</th>
                          <th>Estado</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-telefonos-config"></tbody>
                    </table>
                  </div>

                  <!-- Paginación -->
                  <div class="row justify-between items-center mt-4">
                    <button id="btnPrevPageConfig" class="btn secondary">
                      Anterior
                    </button>
                    <span id="pageIndicatorConfig">Página 1 de 1</span>
                    <button id="btnNextPageConfig" class="btn secondary">
                      Siguiente
                    </button>
                  </div>
                </div>
              </div>

              <!-- Panel Sistema Config -->
              <div id="panel-sistema-config" class="hidden">
                <div class="config-section">
                  <h2>Configuración del Sistema</h2>

                  <div class="ai-suggestion">
                    <h3>🤖 Asistente IA</h3>
                    <p>
                      El sistema puede detectar automáticamente problemas y
                      sugerir mejoras.
                    </p>
                    <div class="row mt-2">
                      <button id="btnAnalisisIA" class="btn secondary">
                        Ejecutar Análisis IA
                      </button>
                      <button id="btnOptimizarBase" class="btn secondary">
                        Optimizar Base de Datos
                      </button>
                    </div>
                    <div id="sugerencias-ia" class="mt-4"></div>
                  </div>

                  <div class="grid-2 mt-4">
                    <div>
                      <h3>Configuración de Estados Telefónicos</h3>
                      <div id="estados-telefonicos-config"></div>
                      <div class="row mt-2">
                        <input
                          type="text"
                          id="nuevo-estado"
                          placeholder="Nuevo estado"
                          class="flex-grow"
                        />
                        <button id="btnAddEstado" class="btn secondary">
                          Añadir
                        </button>
                      </div>
                    </div>
                    <div>
                      <h3>Configuración de Lugares</h3>
                      <div id="lugares-config"></div>
                      <div class="row mt-2">
                        <input
                          type="text"
                          id="nuevo-lugar"
                          placeholder="Nuevo lugar"
                          class="flex-grow"
                        />
                        <button id="btnAddLugarConfig" class="btn secondary">
                          Añadir
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="mt-4">
                    <h3>Respaldo y Restauración</h3>
                    <div class="row">
                      <button id="btnBackupCompleto" class="btn ok">
                        Crear Respaldo Completo
                      </button>
                      <button id="btnRestaurarBackup" class="btn warn">
                        Restaurar desde Archivo
                      </button>
                      <input
                        type="file"
                        id="file-backup"
                        accept=".json"
                        class="hidden"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ======================= -->
          <!-- VISTA MODO ADMINISTRADOR -->
          <!-- ======================= -->
          <div id="viewAdministrador" class="hidden">
            <nav
              class="panel-nav"
              aria-label="Navegación del Panel Administrativo"
            >
              <button class="tab active" data-panel="dashboard">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                  <rect x="9" y="9" width="6" height="6" />
                  <path d="m9 1 0 8" />
                  <path d="m15 1 0 8" />
                  <path d="m1 9 8 0" />
                  <path d="m1 15 8 0" />
                </svg>
                Dashboard
              </button>
              <button class="tab" data-panel="programar-territorio">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                  <line x1="16" y1="2" x2="16" y2="6" />
                  <line x1="8" y1="2" x2="8" y2="6" />
                  <line x1="3" y1="10" x2="21" y2="10" />
                </svg>
                Programar
              </button>
              <button class="tab" data-panel="programa-admin">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                  />
                  <polyline points="14,2 14,8 20,8" />
                  <line x1="16" y1="13" x2="8" y2="13" />
                  <line x1="16" y1="17" x2="8" y2="17" />
                </svg>
                Programa
              </button>
              <button class="tab" data-panel="reportes">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="18" y1="20" x2="18" y2="10" />
                  <line x1="12" y1="20" x2="12" y2="4" />
                  <line x1="6" y1="20" x2="6" y2="14" />
                </svg>
                Reportes
              </button>
              <button
                class="tab"
                data-panel="configuracion"
                id="btnConfiguracionAdmin"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="3" />
                  <path d="m12 1 0 6m0 6 0 6m6-12 -6 0m-6 0 6 0" />
                  <path d="m15.5 15.5 -6-6m0 6 6-6" />
                </svg>
                Configuración
              </button>
            </nav>

            <div id="admin-content">
              <!-- Panel Dashboard -->
              <div id="panel-dashboard">
                <div class="grid-4">
                  <div class="kpi-card">
                    <div id="kpi-asignados" class="kpi-value">0</div>
                    <div class="kpi-label">Territorios Asignados</div>
                  </div>
                  <div class="kpi-card">
                    <div id="kpi-completados" class="kpi-value">0</div>
                    <div class="kpi-label">Territorios Completados</div>
                  </div>
                  <div class="kpi-card">
                    <div id="kpi-progreso" class="kpi-value">0%</div>
                    <div class="kpi-label">Progreso Promedio</div>
                  </div>
                  <div class="kpi-card">
                    <div id="kpi-conductores-activos" class="kpi-value">0</div>
                    <div class="kpi-label">Conductores Activos</div>
                  </div>
                </div>

                <div class="card">
                  <h2>Análisis de Cobertura</h2>
                  <div class="row">
                    <select id="dashboard-search-select" class="flex-grow">
                      <option value="">Ver cobertura general</option>
                    </select>
                    <button id="btnAnalisisCompleto" class="btn secondary">
                      Análisis Completo
                    </button>
                  </div>
                  <div
                    id="dashboard-search-result"
                    class="mt-4 text-center"
                  ></div>
                </div>

                <div class="card">
                  <h2 id="chart-title">Cobertura de Territorios</h2>
                  <div class="chart-container">
                    <canvas id="territoryCoverageChart"></canvas>
                  </div>
                </div>
              </div>

              <!-- Panel Programar Territorio -->
              <div id="panel-programar-territorio" class="hidden">
                <div class="card">
                  <div class="grid-2">
                    <div>
                      <h2>Selección de Territorio</h2>
                      <div
                        id="territorios-dinamicos"
                        class="lista-territorios"
                      ></div>
                      <div class="line-space"></div>
                      <div id="territorioEstado" class="hint">
                        Selecciona un territorio.
                      </div>
                      <div class="line-space"></div>
                      <label>Manzanas del territorio seleccionado</label>
                      <div
                        id="manzanasListaAdmin"
                        class="manzanas-container"
                      ></div>
                      <div id="manzanas-actions-container" class="hidden">
                        <div class="row">
                          <button id="btnSelTodas" class="btn secondary">
                            Seleccionar todas
                          </button>
                          <button id="btnLimpiarSel" class="btn ghost">
                            Limpiar selección
                          </button>
                        </div>
                      </div>
                    </div>

                    <div>
                      <h2>Detalles del Programa</h2>
                      <form id="programa-form">
                        <div class="grid-2">
                          <div>
                            <label for="programa-fecha">Fecha</label>
                            <input type="date" id="programa-fecha" />
                          </div>
                          <div>
                            <label for="programa-hora">Hora</label>
                            <input
                              type="text"
                              id="programa-hora"
                              placeholder="Ej: 8:45am"
                            />
                          </div>
                        </div>
                        <div class="row">
                          <div class="flex-grow">
                            <label for="programa-lugar">Lugar</label>
                            <select
                              id="programa-lugar"
                              class="select-lugares"
                            ></select>
                          </div>
                          <button
                            type="button"
                            id="btnAddLugar"
                            class="btn secondary"
                          >
                            +
                          </button>
                        </div>
                        <div>
                          <label for="programa-conductor">Conductor</label>
                          <select
                            id="programa-conductor"
                            class="select-conductores"
                          ></select>
                        </div>
                        <div>
                          <label for="programa-auxiliar">Auxiliar</label>
                          <select
                            id="programa-auxiliar"
                            class="select-conductores"
                          ></select>
                        </div>
                        <div class="row">
                          <div class="flex-grow">
                            <label for="programa-faceta">Faceta</label>
                            <select
                              id="programa-faceta"
                              class="select-facetas"
                            ></select>
                          </div>
                          <button
                            type="button"
                            id="btnAddFaceta"
                            class="btn secondary"
                          >
                            +
                          </button>
                        </div>
                        <div>
                          <label for="programa-territorio"
                            >Territorio(s) y Manzanas</label
                          >
                          <input
                            type="text"
                            id="programa-territorio"
                            readonly
                          />
                        </div>
                        <div class="row">
                          <button type="submit" class="btn ok">
                            Guardar Programa
                          </button>
                          <button
                            type="button"
                            id="btnLimpiarPrograma"
                            class="btn secondary"
                          >
                            Limpiar
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="row justify-between mb-4">
                    <h2>Estado General de Territorios</h2>
                    <button id="btnExportarS13" class="btn">
                      Exportar S-13
                    </button>
                  </div>
                  <div class="table-wrap">
                    <table>
                      <thead>
                        <tr>
                          <th>Territorio</th>
                          <th>Progreso</th>
                          <th>Estado</th>
                          <th>Asignado a</th>
                          <th>Fecha Asignación</th>
                          <th>Última Completada</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-estado-general"></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Panel Programa Admin -->
              <div id="panel-programa-admin" class="hidden">
                <div class="card">
                  <div class="row justify-between mb-4">
                    <div class="row">
                      <button id="btnSemanaAnterior" class="btn secondary">
                        &lt;
                      </button>
                      <h2 id="programa-nav-title" class="ml-4 mr-4">
                        Semana Actual
                      </h2>
                      <button id="btnSemanaSiguiente" class="btn secondary">
                        &gt;
                      </button>
                    </div>
                    <button id="btnExportarProgramaPDF" class="btn">
                      Exportar PDF
                    </button>
                  </div>
                  <div id="programa-view-admin-container"></div>
                </div>
              </div>

              <!-- Panel Reportes -->
              <div id="panel-reportes" class="hidden">
                <div class="card">
                  <h2>Generación de Reportes</h2>
                  <div class="grid-3">
                    <button id="btnReporteAsignaciones" class="btn secondary">
                      Reporte de Asignaciones
                    </button>
                    <button id="btnReporteCobertura" class="btn secondary">
                      Reporte de Cobertura
                    </button>
                    <button id="btnReporteRendimiento" class="btn secondary">
                      Reporte de Rendimiento
                    </button>
                  </div>
                </div>
              </div>

              <!-- Panel Configuración (Solo SuperAdmin) -->
              <div id="panel-configuracion" class="hidden">
                <div class="config-header card">
                  <div class="config-title">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <circle cx="12" cy="12" r="3" />
                      <path d="m12 1 0 6m0 6 0 6m6-12 -6 0m-6 0 6 0" />
                      <path d="m15.5 15.5 -6-6m0 6 6-6" />
                    </svg>
                    <h2>Configuración del Sistema</h2>
                  </div>
                  <p class="config-subtitle">
                    Panel de configuración avanzada - Solo SuperAdmin
                  </p>
                </div>

                <div class="config-tabs">
                  <nav class="panel-nav">
                    <button class="tab active" data-config-panel="congregacion">
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M12 1L21 9v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9l9-8z"
                        />
                      </svg>
                      Congregación
                    </button>
                    <button class="tab" data-config-panel="territorios-config">
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polygon points="3,11 22,2 13,21 11,13 3,11" />
                      </svg>
                      Territorios
                    </button>
                    <button class="tab" data-config-panel="usuarios-config">
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                      </svg>
                      Usuarios
                    </button>
                    <button class="tab" data-config-panel="telefonos-config">
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                        />
                      </svg>
                      Base Telefónica
                    </button>
                    <button class="tab" data-config-panel="sistema-config">
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <circle cx="12" cy="12" r="3" />
                        <path
                          d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                        />
                      </svg>
                      Sistema
                    </button>
                  </nav>

                  <div id="config-content-admin">
                    <!-- El contenido de configuración se cargará aquí -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ======================= -->
          <!-- VISTA MODO CONDUCTOR -->
          <!-- ======================= -->
          <div id="viewConductor">
            <nav class="panel-nav">
              <button class="tab active" data-panel="asignaciones">
                Mis Asignaciones
              </button>
              <button class="tab" data-panel="telefonica">
                Predicación Telefónica
              </button>
              <button class="tab" data-panel="programa">Programa</button>
            </nav>

            <div id="conductor-content">
              <!-- Panel Asignaciones -->
              <div id="panel-asignaciones">
                <div class="card">
                  <div class="row justify-between mb-4">
                    <h2>Mis Asignaciones</h2>
                    <button
                      id="btnTerritoriosDisponibles"
                      class="btn secondary"
                    >
                      Ver Disponibles
                    </button>
                  </div>
                  <div>
                    <label for="conductorVista">Selecciona tu nombre</label>
                    <select
                      id="conductorVista"
                      class="select-conductores"
                    ></select>
                  </div>
                  <div id="misAsignaciones" class="asig-list"></div>
                </div>
              </div>

              <!-- Panel Telefónica -->
              <div id="panel-telefonica" class="hidden">
                <div class="card">
                  <div class="row justify-between mb-4">
                    <h2>Predicación Telefónica</h2>
                    <div class="row">
                      <button id="btnSolicitarNumeros" class="btn ok">
                        Solicitar Números
                      </button>
                      <button id="btnDescargarListado" class="btn">
                        Descargar PDF
                      </button>
                    </div>
                  </div>
                  <div id="telefonos-loading" class="hidden text-center p-4">
                    <div>Cargando números telefónicos...</div>
                  </div>
                  <div class="table-wrap">
                    <table id="tabla-telefonica">
                      <thead>
                        <tr>
                          <th>Nombre</th>
                          <th>Dirección</th>
                          <th>Teléfono</th>
                          <th>Publicador</th>
                          <th>Estado</th>
                          <th>Comentarios</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-telefonica"></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Panel Programa -->
              <div id="panel-programa" class="hidden">
                <div class="card">
                  <h2>Programa de la Semana</h2>
                  <div id="programa-view-container"></div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div id="loadingIndicator" class="app">
        <div>
          <svg
            class="animate-spin h-8 w-8 mx-auto text-blue-500"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p class="text-center mt-4">
            Inicializando Sistema de Gestión de Territorios...
          </p>
        </div>
      </div>

      <footer>
        <div class="text-center">
          <p>&copy; 2025 Sistema de Gestión de Territorios - Autosustentable</p>
          <p class="text-sm opacity-75">
            Desarrollado con ❤️ para la organización teocática
          </p>
        </div>
      </footer>
    </main>

    <!-- ========================= -->
    <!-- MODALES -->
    <!-- ========================= -->
    <!-- Modales principales -->
    <dialog id="modalMensaje">
      <div class="modal-body text-center">
        <p id="mensajeTexto" class="mb-4 text-lg"></p>
        <button class="btn" data-action="close-modal">Entendido</button>
      </div>
    </dialog>

    <dialog id="modalConfirmar">
      <div class="modal-body text-center">
        <p id="confirmText" class="mb-4"></p>
        <div class="row justify-center">
          <button id="btnConfirmYes" class="btn err">Confirmar</button>
          <button id="btnConfirmNo" class="btn secondary">Cancelar</button>
        </div>
      </div>
    </dialog>

    <dialog id="modalPassword">
      <div class="modal-head">
        <div class="login-icon">
          <svg
            width="32"
            height="32"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
            <circle cx="12" cy="7" r="4" />
          </svg>
        </div>
        <strong>Acceso de Administrador</strong>
        <p class="login-subtitle">Ingresa tus credenciales para continuar</p>
      </div>
      <div class="modal-body">
        <form id="passwordForm">
          <div class="form-group">
            <label for="adminPhone">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                />
              </svg>
              Teléfono (SuperAdmin)
            </label>
            <input
              type="tel"
              id="adminPhone"
              placeholder="0994749286"
              class="form-input-professional"
            />
            <small class="field-hint"
              >Solo necesario para acceso SuperAdmin</small
            >
          </div>
          <div class="form-group">
            <label for="passwordInput">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                <circle cx="12" cy="16" r="1" />
                <path d="m7 11V7a5 5 0 0 1 10 0v4" />
              </svg>
              Contraseña
            </label>
            <div class="password-container">
              <input
                type="password"
                id="passwordInput"
                placeholder="Ingresa tu contraseña"
                autocomplete="current-password"
                required
                class="form-input-professional"
              />
              <button type="button" id="togglePassword" class="password-toggle">
                <svg
                  id="eyeIcon"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
              </button>
            </div>
          </div>
          <div id="passwordError" class="error-message hidden">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" />
              <line x1="15" y1="9" x2="9" y2="15" />
              <line x1="9" y1="9" x2="15" y2="15" />
            </svg>
            Credenciales incorrectas. Verifica tu información.
          </div>
          <div class="login-actions">
            <button
              type="button"
              class="btn secondary"
              data-action="close-modal"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
              Cancelar
            </button>
            <button type="submit" class="btn ok" id="loginSubmit">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="m9 18 6-6-6-6" />
              </svg>
              Acceder
              <div class="btn-loading hidden">
                <div class="spinner"></div>
              </div>
            </button>
          </div>
        </form>
      </div>
    </dialog>

    <!-- Modal Devolución de Territorio -->
    <dialog id="modalDevolver">
      <div class="modal-head">
        <strong>Devolver Territorio</strong>
      </div>
      <div class="modal-body">
        <form id="devolverForm">
          <input type="hidden" id="devolverTerritorioId" />
          <input type="hidden" id="devolverAsignacionIndex" />
          <p class="mb-4">
            Confirmar devolución para
            <strong id="devolverInfoTerritorio"></strong>.
          </p>
          <label for="devolverFecha">Fecha de finalización</label>
          <input type="date" id="devolverFecha" required />
          <label for="devolverComentarios">Comentarios (opcional)</label>
          <textarea
            id="devolverComentarios"
            rows="3"
            placeholder="Notas sobre la predicación realizada..."
          ></textarea>
          <div class="row justify-end mt-4">
            <button
              type="button"
              class="btn secondary"
              data-action="close-modal"
            >
              Cancelar
            </button>
            <button type="submit" class="btn ok">Confirmar Devolución</button>
          </div>
        </form>
      </div>
    </dialog>

    <!-- Modal Territorios Disponibles -->
    <dialog id="modalTerritoriosDisponibles">
      <div class="modal-head">
        <strong>Territorios Disponibles</strong>
        <button class="btn ghost" data-action="close-modal">×</button>
      </div>
      <div class="modal-body">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Territorio</th>
                <th>Manzanas</th>
                <th>Última vez completado</th>
                <th>Prioridad</th>
              </tr>
            </thead>
            <tbody id="tbodyTerritoriosDisponibles"></tbody>
          </table>
        </div>
      </div>
    </dialog>

    <!-- Modal Gestión de Asignaciones -->
    <dialog id="modalHistorial">
      <div class="modal-head">
        <strong id="historialTitulo">Gestor de Asignaciones</strong>
        <button class="btn ghost" data-action="close-modal">×</button>
      </div>
      <div id="historialBody" class="modal-body"></div>
    </dialog>

    <!-- Modal Exportar S-13 -->
    <dialog id="modalExportarS13">
      <div class="modal-head">
        <strong>Exportar Registro S-13</strong>
      </div>
      <div class="modal-body">
        <form id="exportS13Form">
          <p class="hint mb-4">
            Selecciona el rango de fechas para el informe S-13.
          </p>
          <div class="grid-2">
            <div>
              <label for="exportStartDate">Fecha de Inicio</label>
              <input type="date" id="exportStartDate" required />
            </div>
            <div>
              <label for="exportEndDate">Fecha de Fin</label>
              <input type="date" id="exportEndDate" required />
            </div>
          </div>
          <div class="mt-4">
            <label>
              <input type="checkbox" id="incluirDetalles" /> Incluir detalles de
              manzanas
            </label>
          </div>
          <div class="row justify-end mt-4">
            <button
              type="button"
              class="btn secondary"
              data-action="close-modal"
            >
              Cancelar
            </button>
            <button type="submit" class="btn ok">Generar S-13</button>
          </div>
        </form>
      </div>
    </dialog>

    <!-- Modal Añadir Lugares y Facetas -->
    <dialog id="modalAddLugar">
      <div class="modal-head">
        <strong>Agregar Nuevo Lugar</strong>
      </div>
      <div class="modal-body">
        <form id="addLugarForm">
          <label for="newLugarNameModal">Nombre del lugar</label>
          <input
            type="text"
            id="newLugarNameModal"
            placeholder="Ej: Familia Pérez"
            required
          />
          <div class="row justify-end mt-4">
            <button
              type="button"
              class="btn secondary"
              data-action="close-modal"
            >
              Cancelar
            </button>
            <button type="submit" class="btn ok">Agregar</button>
          </div>
        </form>
      </div>
    </dialog>

    <dialog id="modalAddFaceta">
      <div class="modal-head">
        <strong>Agregar Nueva Faceta</strong>
      </div>
      <div class="modal-body">
        <form id="addFacetaForm">
          <label for="newFacetaNameModal">Nombre de la faceta</label>
          <input
            type="text"
            id="newFacetaNameModal"
            placeholder="Ej: Calles principales"
            required
          />
          <div class="row justify-end mt-4">
            <button
              type="button"
              class="btn secondary"
              data-action="close-modal"
            >
              Cancelar
            </button>
            <button type="submit" class="btn ok">Agregar</button>
          </div>
        </form>
      </div>
    </dialog>

    <!-- Modal Añadir Registro Telefónico Manual -->
    <dialog id="modalAddTelefono">
      <div class="modal-head">
        <strong>Añadir Registro Telefónico</strong>
      </div>
      <div class="modal-body">
        <form id="addTelefonoForm">
          <div class="grid-2">
            <div>
              <label for="addTelefonoNombre">Nombre</label>
              <input type="text" id="addTelefonoNombre" required />
            </div>
            <div>
              <label for="addTelefonoTelefono">Teléfono</label>
              <input type="tel" id="addTelefonoTelefono" required />
            </div>
          </div>
          <div class="mt-4">
            <label for="addTelefonoDireccion">Dirección</label>
            <textarea id="addTelefonoDireccion" rows="2" required></textarea>
          </div>
          <div class="row justify-end mt-4">
            <button
              type="button"
              class="btn secondary"
              data-action="close-modal"
            >
              Cancelar
            </button>
            <button type="submit" class="btn ok">Guardar</button>
          </div>
        </form>
      </div>
    </dialog>
  </body>

  <!-- JavaScript Principal -->
  <script type="module">
    // MÓDULO DE FIRESTORE Y CONFIGURACIÓN
    // 🚫 FIREBASE INITIALIZATION DISABLED TO PREVENT API ERRORS
    console.warn(
      "🚫 Firebase disabled in src/index.html to prevent API key errors"
    );
    console.log("💡 Using offline mode - all data stored locally");

    // Mock Firebase objects
    const app = null;
    const db = null;
    const auth = null;
    const appId = "conductores-app-v2";

    // ESTADO GLOBAL MODERNIZADO
    const estadoApp = {
      // Configuración de la congregación
      configuracion: {
        congregacion: {
          nombre: "Sistema de Gestión de Territorios",
          ciudad: "",
          pais: "",
          coordinador: "",
        },
        territorios: {
          total: 22,
          manzanasPorTerritorio: {},
        },
        estadosTelefonicos: [
          "",
          "Colgaron",
          "No llamar",
          "Contestaron",
          "Revisita",
          "Devuelto",
          "No contestaron",
          "Testigo",
        ],
        lugares: ["Salón del Reino", "Zoom"],
        facetas: ["Casa en casa", "Negocios"],
      },

      // Datos operativos
      conductores: [],
      publicadores: [],
      territorios: {},
      programa: [],
      listadoTelefonico: [],
      listadoTelefonicoActual: [],

      // Estado de UI
      territoriosSeleccionados: new Set(),
      manzanasSeleccionadas: new Set(),
      modoActual: "conductor",
      panelActivo: "asignaciones",
      isAdministrador: false,
      isSuperAdmin: false,
      currentUser: null,
      currentUserRole: null,
      semanaOffset: 0, // Paginación y filtros
      paginacion: {
        telefonosConfig: { currentPage: 1, pageSize: 25 },
        telefonosAdmin: { currentPage: 1, pageSize: 50 },
      },
      filtros: {
        nombre: "",
        telefono: "",
        estado: "",
      },

      // Callbacks y temporal
      confirmCallback: null,
      coverageChart: null,
    };

    // Credenciales Super Admin
    const SUPER_ADMIN = {
      phone: "0994749286",
      password: "Sonita.09",
      role: "superadmin",
    };

    // SELECTORES DOM OPTIMIZADOS
    const dom = {
      // Contenedores principales
      appContainer: document.getElementById("app-container"),
      loadingIndicator: document.getElementById("loadingIndicator"),
      congregacionHeader: document.getElementById("congregacion-header"),
      congregacionNombre: document.getElementById("congregacion-nombre"),
      congregacionInfo: document.getElementById("congregacion-info"),

      // Botones de modo
      btnModoConductor: document.getElementById("btnModoConductor"),
      btnModoAdministrador: document.getElementById("btnModoAdministrador"),
      btnModoConfiguracion: document.getElementById("btnModoConfiguracion"),

      // Vistas principales
      viewConductor: document.getElementById("viewConductor"),
      viewAdministrador: document.getElementById("viewAdministrador"),
      viewConfiguracion: document.getElementById("viewConfiguracion"),

      // Navegación
      configNav: document.querySelector("#viewConfiguracion .panel-nav"),
      adminNav: document.querySelector("#viewAdministrador .panel-nav"),
      conductorNav: document.querySelector("#viewConductor .panel-nav"),

      // Contenidos
      configContent: document.getElementById("config-content"),
      adminContent: document.getElementById("admin-content"),
      conductorContent: document.getElementById("conductor-content"),

      // Configuración - Congregación
      configCongregacionNombre: document.getElementById(
        "config-congregacion-nombre"
      ),
      configCongregacionCiudad: document.getElementById(
        "config-congregacion-ciudad"
      ),
      configCongregacionPais: document.getElementById(
        "config-congregacion-pais"
      ),
      configCoordinador: document.getElementById("config-coordinador"),
      congregacionForm: document.getElementById("congregacion-form"),

      // Configuración - Territorios
      configTotalTerritorios: document.getElementById(
        "config-total-territorios"
      ),
      btnActualizarTerritorios: document.getElementById(
        "btnActualizarTerritorios"
      ),
      territoriosPreview: document.getElementById("territorios-preview"),
      manzanasConfigContainer: document.getElementById(
        "manzanas-config-container"
      ),
      btnGuardarManzanas: document.getElementById("btnGuardarManzanas"),

      // Configuración - Usuarios
      configNuevoConductor: document.getElementById("config-nuevo-conductor"),
      btnAddConductor: document.getElementById("btnAddConductor"),
      configConductoresList: document.getElementById("config-conductores-list"),
      configNuevoPublicador: document.getElementById("config-nuevo-publicador"),
      btnAddPublicador: document.getElementById("btnAddPublicador"),
      configPublicadoresList: document.getElementById(
        "config-publicadores-list"
      ),

      // Configuración - Teléfonos
      totalRegistros: document.getElementById("total-registros"),
      registrosActivos: document.getElementById("registros-activos"),
      registrosDuplicados: document.getElementById("registros-duplicados"),
      importTelefonosZone: document.getElementById("import-telefonos-zone"),
      fileImportTelefonos: document.getElementById("file-import-telefonos"),
      btnAddRegistroManual: document.getElementById("btnAddRegistroManual"),
      btnLimpiarDuplicadosConfig: document.getElementById(
        "btnLimpiarDuplicadosConfig"
      ),
      btnExportarTelefonos: document.getElementById("btnExportarTelefonos"),
      btnResetTelefonos: document.getElementById("btnResetTelefonos"),
      tablaTelefonosConfig: document.getElementById("tabla-telefonos-config"),
      tbodyTelefonosConfig: document.getElementById("tbody-telefonos-config"),

      // Administrador
      kpiAsignados: document.getElementById("kpi-asignados"),
      kpiCompletados: document.getElementById("kpi-completados"),
      kpiProgreso: document.getElementById("kpi-progreso"),
      kpiConductoresActivos: document.getElementById("kpi-conductores-activos"),
      dashboardSearchSelect: document.getElementById("dashboard-search-select"),
      dashboardSearchResult: document.getElementById("dashboard-search-result"),
      chartTitle: document.getElementById("chart-title"),
      territoryCoverageChart: document.getElementById("territoryCoverageChart"),
      territoriosDinamicos: document.getElementById("territorios-dinamicos"),
      manzanasListaAdmin: document.getElementById("manzanasListaAdmin"),
      manzanasActionsContainer: document.getElementById(
        "manzanas-actions-container"
      ),
      btnSelTodas: document.getElementById("btnSelTodas"),
      btnLimpiarSel: document.getElementById("btnLimpiarSel"),
      programaForm: document.getElementById("programa-form"),
      programaFecha: document.getElementById("programa-fecha"),
      programaTerritorio: document.getElementById("programa-territorio"),
      btnExportarS13: document.getElementById("btnExportarS13"),
      tbodyEstadoGeneral: document.getElementById("tbody-estado-general"),

      // Conductor
      conductorVista: document.getElementById("conductorVista"),
      misAsignaciones: document.getElementById("misAsignaciones"),
      btnTerritoriosDisponibles: document.getElementById(
        "btnTerritoriosDisponibles"
      ),
      btnSolicitarNumeros: document.getElementById("btnSolicitarNumeros"),
      btnDescargarListado: document.getElementById("btnDescargarListado"),
      telefonosLoading: document.getElementById("telefonos-loading"),
      tbodyTelefonica: document.getElementById("tbody-telefonica"),
      programaViewContainer: document.getElementById("programa-view-container"),

      // Modales
      modalMensaje: document.getElementById("modalMensaje"),
      mensajeTexto: document.getElementById("mensajeTexto"),
      modalConfirmar: document.getElementById("modalConfirmar"),
      confirmText: document.getElementById("confirmText"),
      btnConfirmYes: document.getElementById("btnConfirmYes"),
      btnConfirmNo: document.getElementById("btnConfirmNo"),
      modalPassword: document.getElementById("modalPassword"),
      passwordForm: document.getElementById("passwordForm"),
      adminPhone: document.getElementById("adminPhone"),
      passwordInput: document.getElementById("passwordInput"),
      passwordError: document.getElementById("passwordError"),
      togglePassword: document.getElementById("togglePassword"),
      eyeIcon: document.getElementById("eyeIcon"),
      btnConfiguracionAdmin: document.getElementById("btnConfiguracionAdmin"),
      modalDevolver: document.getElementById("modalDevolver"),
      devolverForm: document.getElementById("devolverForm"),
      modalTerritoriosDisponibles: document.getElementById(
        "modalTerritoriosDisponibles"
      ),
      modalHistorial: document.getElementById("modalHistorial"),
      modalExportarS13: document.getElementById("modalExportarS13"),
      modalAddLugar: document.getElementById("modalAddLugar"),
      modalAddFaceta: document.getElementById("modalAddFaceta"),
      modalAddTelefono: document.getElementById("modalAddTelefono"),
    };

    // UTILIDADES MODERNAS
    const utils = {
      todayISO: () => new Date().toISOString().slice(0, 10),

      // Notificaciones mejoradas
      showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => notification.classList.add("show"), 100);
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => document.body.removeChild(notification), 300);
        }, 3000);
      },

      // Mostrar mensaje en modal
      showMessage(texto) {
        dom.mensajeTexto.textContent = texto;
        dom.modalMensaje.showModal();
      },

      // Mostrar confirmación
      showConfirmation(texto, callback) {
        dom.confirmText.textContent = texto;
        estadoApp.confirmCallback = callback;
        dom.modalConfirmar.showModal();
      },

      // Generar ID único
      generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
      },

      // Validar teléfono
      validatePhone(phone) {
        return /^[\d\s\-\+\(\)]{7,15}$/.test(phone.replace(/\s/g, ""));
      },

      // Detectar duplicados por similitud
      findSimilar(item, list, threshold = 0.8) {
        return list.filter((listItem) => {
          if (listItem.id === item.id) return false;

          const similarity = this.stringSimilarity(
            item.nombre?.toLowerCase() || "",
            listItem.nombre?.toLowerCase() || ""
          );

          return similarity > threshold || item.telefono === listItem.telefono;
        });
      },

      // Calcular similitud entre strings
      stringSimilarity(str1, str2) {
        if (!str1 || !str2) return 0;
        const longer = str1.length > str2.length ? str1 : str2;
        const shorter = str1.length > str2.length ? str2 : str1;
        if (longer.length === 0) return 1.0;
        return (
          (longer.length - this.levenshteinDistance(longer, shorter)) /
          longer.length
        );
      },

      // Distancia de Levenshtein
      levenshteinDistance(str1, str2) {
        const matrix = [];
        for (let i = 0; i <= str2.length; i++) {
          matrix[i] = [i];
        }
        for (let j = 0; j <= str1.length; j++) {
          matrix[0][j] = j;
        }
        for (let i = 1; i <= str2.length; i++) {
          for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
              matrix[i][j] = matrix[i - 1][j - 1];
            } else {
              matrix[i][j] = Math.min(
                matrix[i - 1][j - 1] + 1,
                matrix[i][j - 1] + 1,
                matrix[i - 1][j] + 1
              );
            }
          }
        }
        return matrix[str2.length][str1.length];
      },
    };

    // REFERENCIAS FIRESTORE OPTIMIZADAS
    const firestore = {
      // Configuración
      configDoc: () => doc(db, "artifacts", appId, "config", "app"),

      // Collections
      conductores: () =>
        collection(db, "artifacts", appId, "public", "data", "conductores"),
      publicadores: () =>
        collection(db, "artifacts", appId, "public", "data", "publicadores"),
      territorios: () =>
        collection(db, "artifacts", appId, "public", "data", "territorios"),
      programa: () =>
        collection(db, "artifacts", appId, "public", "data", "programa"),
      telefonos: () =>
        collection(db, "artifacts", appId, "public", "data", "telefonos"),
      lugares: () =>
        collection(db, "artifacts", appId, "public", "data", "lugares"),
      facetas: () =>
        collection(db, "artifacts", appId, "public", "data", "facetas"),

      // Documents
      conductorDoc: (id) =>
        doc(db, "artifacts", appId, "public", "data", "conductores", id),
      publicadorDoc: (id) =>
        doc(db, "artifacts", appId, "public", "data", "publicadores", id),
      territorioDoc: (id) =>
        doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "territorios",
          String(id)
        ),
      telefonoDoc: (id) =>
        doc(db, "artifacts", appId, "public", "data", "telefonos", id),
      programaDoc: (id) =>
        doc(db, "artifacts", appId, "public", "data", "programa", id),
      lugarDoc: (id) =>
        doc(db, "artifacts", appId, "public", "data", "lugares", id),
      facetaDoc: (id) =>
        doc(db, "artifacts", appId, "public", "data", "facetas", id),
    };

    // SISTEMA DE CONFIGURACIÓN AUTOSUSTENTABLE
    const configuracionManager = {
      async cargarConfiguracion() {
        try {
          const configSnap = await getDoc(firestore.configDoc());
          if (configSnap.exists()) {
            const config = configSnap.data();
            estadoApp.configuracion = { ...estadoApp.configuracion, ...config };
            this.aplicarConfiguracion();
          } else {
            await this.inicializarConfiguracionDefault();
          }
        } catch (error) {
          console.error("Error cargando configuración:", error);
          await this.inicializarConfiguracionDefault();
        }
      },

      async inicializarConfiguracionDefault() {
        // Crear configuración default con 22 territorios
        const manzanasDefault = {};
        for (let i = 1; i <= 22; i++) {
          manzanasDefault[i] = Math.floor(Math.random() * 6) + 1; // 1-6 manzanas
        }

        estadoApp.configuracion.territorios.manzanasPorTerritorio =
          manzanasDefault;

        try {
          await setDoc(firestore.configDoc(), estadoApp.configuracion);
          utils.showNotification("Configuración inicializada correctamente");
        } catch (error) {
          console.error("Error inicializando configuración:", error);
        }
      },

      aplicarConfiguracion() {
        const { congregacion } = estadoApp.configuracion;

        // Actualizar header
        if (congregacion.nombre) {
          dom.congregacionNombre.textContent = congregacion.nombre;
        }

        if (congregacion.ciudad && congregacion.pais) {
          dom.congregacionInfo.textContent = `${congregacion.ciudad}, ${congregacion.pais}`;
        }

        // Actualizar formularios de configuración
        if (dom.configCongregacionNombre) {
          dom.configCongregacionNombre.value = congregacion.nombre || "";
          dom.configCongregacionCiudad.value = congregacion.ciudad || "";
          dom.configCongregacionPais.value = congregacion.pais || "";
          dom.configCoordinador.value = congregacion.coordinador || "";
        }

        if (dom.configTotalTerritorios) {
          dom.configTotalTerritorios.value =
            estadoApp.configuracion.territorios.total;
        }
      },

      async guardarConfiguracion() {
        try {
          await setDoc(firestore.configDoc(), estadoApp.configuracion);
          utils.showNotification("Configuración guardada correctamente");
          this.aplicarConfiguracion();
        } catch (error) {
          console.error("Error guardando configuración:", error);
          utils.showNotification("Error al guardar la configuración", "error");
        }
      },

      async actualizarCongregacion(datos) {
        estadoApp.configuracion.congregacion = {
          ...estadoApp.configuracion.congregacion,
          ...datos,
        };
        await this.guardarConfiguracion();
      },

      async actualizarTerritorios(total, manzanasPorTerritorio) {
        estadoApp.configuracion.territorios = { total, manzanasPorTerritorio };
        await this.guardarConfiguracion();

        // Regenerar territorios en la UI
        territoriosManager.generarTerritoriosDinamicos();
        territoriosManager.generarConfiguracionManzanas();
      },
    };

    // GESTOR DE TERRITORIOS DINÁMICO
    const territoriosManager = {
      generarTerritoriosDinamicos() {
        const total = estadoApp.configuracion.territorios.total;
        let html = "";

        for (let i = 1; i <= total; i++) {
          html += `<button data-terr="${i}" class="territorio-btn">${i}</button>`;
        }

        if (dom.territoriosDinamicos) {
          dom.territoriosDinamicos.innerHTML = html;
        }

        // Actualizar selects de dashboard
        this.actualizarSelectsTerritorios();
      },

      generarConfiguracionManzanas() {
        const total = estadoApp.configuracion.territorios.total;
        const manzanas =
          estadoApp.configuracion.territorios.manzanasPorTerritorio;
        let html = "";

        for (let i = 1; i <= total; i++) {
          html += `
                    <div class="config-territorio-item">
                        <label for="manzanas-t${i}">T${i}</label>
                        <input type="number" id="manzanas-t${i}" min="1" max="20" value="${
            manzanas[i] || 1
          }" 
                               data-territorio="${i}" class="manzanas-input">
                    </div>
                `;
        }

        if (dom.manzanasConfigContainer) {
          dom.manzanasConfigContainer.innerHTML = html;
        }
      },

      actualizarSelectsTerritorios() {
        const total = estadoApp.configuracion.territorios.total;
        let optionsHTML = '<option value="">Ver cobertura general</option>';

        for (let i = 1; i <= total; i++) {
          optionsHTML += `<option value="${i}">Territorio ${i}</option>`;
        }

        if (dom.dashboardSearchSelect) {
          dom.dashboardSearchSelect.innerHTML = optionsHTML;
        }
      },

      async guardarConfiguracionManzanas() {
        const inputs = document.querySelectorAll(".manzanas-input");
        const manzanasPorTerritorio = {};

        inputs.forEach((input) => {
          const territorio = input.dataset.territorio;
          const manzanas = parseInt(input.value) || 1;
          manzanasPorTerritorio[territorio] = manzanas;
        });

        await configuracionManager.actualizarTerritorios(
          estadoApp.configuracion.territorios.total,
          manzanasPorTerritorio
        );

        utils.showNotification("Configuración de manzanas guardada");
      },
    };

    // GESTOR DE BASE TELEFÓNICA AVANZADO
    const telefonosManager = {
      currentPage: 1,
      pageSize: 25,
      filteredData: [],

      async importarCSV(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const data = e.target.result;
              let registros = [];

              if (file.name.endsWith(".csv")) {
                registros = this.parseCSV(data);
              } else if (
                file.name.endsWith(".xlsx") ||
                file.name.endsWith(".xls")
              ) {
                registros = this.parseExcel(data);
              }

              await this.guardarRegistrosMasivos(registros);
              resolve(registros.length);
            } catch (error) {
              reject(error);
            }
          };
          reader.readAsArrayBuffer(file);
        });
      },

      parseCSV(data) {
        const lines = data.split("\n").filter((line) => line.trim());
        const registros = [];

        for (let i = 1; i < lines.length; i++) {
          // Skip header
          const cols = lines[i]
            .split(",")
            .map((col) => col.trim().replace(/"/g, ""));
          if (cols.length >= 3 && cols[0] && cols[2]) {
            registros.push({
              nombre: cols[0],
              direccion: cols[1] || "",
              telefono: cols[2],
              estado: "",
              comentarios: "",
              fechaCreacion: new Date(),
            });
          }
        }
        return registros;
      },

      parseExcel(data) {
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        const registros = [];
        for (let i = 1; i < jsonData.length; i++) {
          // Skip header
          const row = jsonData[i];
          if (row.length >= 3 && row[0] && row[2]) {
            registros.push({
              nombre: String(row[0]).trim(),
              direccion: String(row[1] || "").trim(),
              telefono: String(row[2]).trim(),
              estado: "",
              comentarios: "",
              fechaCreacion: new Date(),
            });
          }
        }
        return registros;
      },

      async guardarRegistrosMasivos(registros) {
        const batch = writeBatch(db);
        let contador = 0;

        for (const registro of registros) {
          if (utils.validatePhone(registro.telefono)) {
            const docRef = doc(firestore.telefonos());
            batch.set(docRef, {
              ...registro,
              id: docRef.id,
              fechaCreacion: serverTimestamp(),
            });
            contador++;

            // Firestore batch limit is 500
            if (contador % 400 === 0) {
              await batch.commit();
              const newBatch = writeBatch(db);
            }
          }
        }

        if (contador % 400 !== 0) {
          await batch.commit();
        }

        return contador;
      },

      async limpiarDuplicados() {
        const duplicados = this.detectarDuplicados();

        if (duplicados.length === 0) {
          utils.showNotification("No se encontraron duplicados");
          return;
        }

        const confirmacion = await new Promise((resolve) => {
          utils.showConfirmation(
            `Se encontraron ${duplicados.length} registros duplicados. ¿Deseas eliminarlos?`,
            () => resolve(true)
          );
          dom.btnConfirmNo.onclick = () => resolve(false);
        });

        if (confirmacion) {
          const batch = writeBatch(db);
          duplicados.forEach((dup) => {
            batch.delete(firestore.telefonoDoc(dup.id));
          });

          await batch.commit();
          utils.showNotification(`${duplicados.length} duplicados eliminados`);
        }
      },

      detectarDuplicados() {
        const duplicados = [];
        const seen = new Set();

        estadoApp.listadoTelefonico.forEach((registro) => {
          const key = `${registro.nombre.toLowerCase()}_${registro.telefono}`;
          if (seen.has(key)) {
            duplicados.push(registro);
          } else {
            seen.add(key);
          }
        });

        return duplicados;
      },

      renderTablaConfig() {
        this.aplicarFiltros();
        const startIdx = (this.currentPage - 1) * this.pageSize;
        const endIdx = startIdx + this.pageSize;
        const pageData = this.filteredData.slice(startIdx, endIdx);

        const html = pageData
          .map(
            (registro) => `
                <tr>
                    <td class="name-cell">${registro.nombre}</td>
                    <td class="address-cell">${registro.direccion}</td>
                    <td>${registro.telefono}</td>
                    <td>${registro.estado || "Sin estado"}</td>
                    <td class="row">
                        <button class="btn-sm btn secondary" onclick="telefonosManager.editarRegistro('${
                          registro.id
                        }')">
                            Editar
                        </button>
                        <button class="btn-sm btn err" onclick="telefonosManager.eliminarRegistro('${
                          registro.id
                        }')">
                            Eliminar
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");

        dom.tbodyTelefonosConfig.innerHTML = html;
        this.actualizarPaginacion();
        this.actualizarEstadisticas();
      },

      aplicarFiltros() {
        const { nombre, telefono, estado } = estadoApp.filtros;

        this.filteredData = estadoApp.listadoTelefonico.filter((registro) => {
          const nombreMatch =
            !nombre ||
            registro.nombre.toLowerCase().includes(nombre.toLowerCase());
          const telefonoMatch =
            !telefono || registro.telefono.includes(telefono);
          const estadoMatch = !estado || registro.estado === estado;

          return nombreMatch && telefonoMatch && estadoMatch;
        });
      },

      actualizarPaginacion() {
        const totalPages = Math.ceil(this.filteredData.length / this.pageSize);
        const pageIndicator = document.getElementById("pageIndicatorConfig");

        if (pageIndicator) {
          pageIndicator.textContent = `Página ${this.currentPage} de ${
            totalPages || 1
          }`;
        }

        const btnPrev = document.getElementById("btnPrevPageConfig");
        const btnNext = document.getElementById("btnNextPageConfig");

        if (btnPrev) btnPrev.disabled = this.currentPage === 1;
        if (btnNext)
          btnNext.disabled =
            this.currentPage === totalPages || totalPages === 0;
      },

      actualizarEstadisticas() {
        const total = estadoApp.listadoTelefonico.length;
        const activos = estadoApp.listadoTelefonico.filter(
          (r) => !r.suspendido
        ).length;
        const duplicados = this.detectarDuplicados().length;

        if (dom.totalRegistros) dom.totalRegistros.textContent = total;
        if (dom.registrosActivos) dom.registrosActivos.textContent = activos;
        if (dom.registrosDuplicados)
          dom.registrosDuplicados.textContent = duplicados;
      },

      async eliminarRegistro(id) {
        const confirmacion = await new Promise((resolve) => {
          utils.showConfirmation(
            "¿Estás seguro de eliminar este registro?",
            () => resolve(true)
          );
          dom.btnConfirmNo.onclick = () => resolve(false);
        });

        if (confirmacion) {
          await deleteDoc(firestore.telefonoDoc(id));
          utils.showNotification("Registro eliminado");
        }
      },
    };

    // SISTEMA DE IA PARA AUTO-CORRECCIÓN
    const sistemaIA = {
      async ejecutarAnalisisCompleto() {
        utils.showNotification("Ejecutando análisis IA...", "warning");

        const analisis = {
          duplicados: telefonosManager.detectarDuplicados(),
          territoriosSinAsignar: this.analizarTerritoriosSinAsignar(),
          conductoresInactivos: this.analizarConductoresInactivos(),
          optimizaciones: this.sugerirOptimizaciones(),
        };

        this.mostrarResultadosAnalisis(analisis);
      },

      analizarTerritoriosSinAsignar() {
        const territoriosSinAsignar = [];
        const total = estadoApp.configuracion.territorios.total;

        for (let i = 1; i <= total; i++) {
          const territorio = estadoApp.territorios[i];
          if (
            !territorio ||
            !territorio.asignaciones ||
            territorio.asignaciones.filter((a) => a.estado === "activo")
              .length === 0
          ) {
            territoriosSinAsignar.push(i);
          }
        }

        return territoriosSinAsignar;
      },

      analizarConductoresInactivos() {
        return estadoApp.conductores.filter((conductor) => {
          const tieneAsignaciones = Object.values(estadoApp.territorios).some(
            (territorio) =>
              territorio.asignaciones?.some(
                (asig) =>
                  asig.conductor === conductor.nombre &&
                  asig.estado === "activo"
              )
          );
          return !tieneAsignaciones;
        });
      },

      sugerirOptimizaciones() {
        const sugerencias = [];

        // Sugerir territorios por completar hace tiempo
        Object.entries(estadoApp.territorios).forEach(([id, territorio]) => {
          if (territorio.historialAsignaciones?.length > 0) {
            const ultimaFecha = new Date(
              territorio.historialAsignaciones[
                territorio.historialAsignaciones.length - 1
              ].fechaDevolucion
            );
            const mesesSinAsignar =
              (new Date() - ultimaFecha) / (1000 * 60 * 60 * 24 * 30);

            if (mesesSinAsignar > 6) {
              sugerencias.push(
                `Territorio ${id}: ${mesesSinAsignar.toFixed(
                  1
                )} meses sin asignar`
              );
            }
          }
        });

        return sugerencias;
      },

      mostrarResultadosAnalisis(analisis) {
        const sugerenciasDiv = document.getElementById("sugerencias-ia");
        if (!sugerenciasDiv) return;

        let html = '<div class="ai-analysis-results">';

        if (analisis.duplicados.length > 0) {
          html += `<div class="ai-suggestion warning">
                    📞 Se encontraron ${analisis.duplicados.length} registros telefónicos duplicados.
                    <button onclick="telefonosManager.limpiarDuplicados()" class="btn-sm btn warn ml-2">Limpiar</button>
                </div>`;
        }

        if (analisis.territoriosSinAsignar.length > 0) {
          html += `<div class="ai-suggestion error">
                    🗺️ Territorios sin asignar: ${analisis.territoriosSinAsignar.join(
                      ", "
                    )}
                </div>`;
        }

        if (analisis.conductoresInactivos.length > 0) {
          html += `<div class="ai-suggestion warning">
                    👥 Conductores sin asignaciones activas: ${analisis.conductoresInactivos
                      .map((c) => c.nombre)
                      .join(", ")}
                </div>`;
        }

        if (analisis.optimizaciones.length > 0) {
          html += `<div class="ai-suggestion">
                    💡 Sugerencias de optimización:
                    <ul>${analisis.optimizaciones
                      .map((s) => `<li>${s}</li>`)
                      .join("")}</ul>
                </div>`;
        }

        if (
          analisis.duplicados.length === 0 &&
          analisis.territoriosSinAsignar.length === 0 &&
          analisis.conductoresInactivos.length === 0 &&
          analisis.optimizaciones.length === 0
        ) {
          html +=
            '<div class="ai-suggestion success">✅ Sistema optimizado. No se encontraron problemas.</div>';
        }

        html += "</div>";
        sugerenciasDiv.innerHTML = html;
      },
    };

    // EVENTOS Y NAVEGACIÓN PRINCIPALES
    function configurarEventosNavegacion() {
      // Los botones de modo ahora son manejados por el sistema de login expandible
      // No necesitamos configurar eventos para botones que ya no existen

      // Toggle de contraseña en login
      dom.togglePassword?.addEventListener("click", () => {
        const passwordInput = dom.passwordInput;
        const eyeIcon = dom.eyeIcon;

        if (passwordInput.type === "password") {
          passwordInput.type = "text";
          eyeIcon.innerHTML = `<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                              <line x1="1" y1="1" x2="23" y2="23"/>`;
        } else {
          passwordInput.type = "password";
          eyeIcon.innerHTML = `<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                              <circle cx="12" cy="12" r="3"/>`;
        }
      });

      // Navegación de configuración
      dom.configNav?.addEventListener("click", (e) => {
        if (e.target.hasAttribute("data-panel")) {
          navegarConfiguracion(e.target.dataset.panel);
        }
      });

      // Navegación de administrador
      dom.adminNav?.addEventListener("click", (e) => {
        if (e.target.hasAttribute("data-panel")) {
          navegarAdministrador(e.target.dataset.panel);
        }
      });

      // Navegación de conductor
      dom.conductorNav?.addEventListener("click", (e) => {
        if (e.target.hasAttribute("data-panel")) {
          navegarConductor(e.target.dataset.panel);
        }
      });

      // Navegación de configuración dentro del panel admin
      document.addEventListener("click", (e) => {
        if (e.target.dataset.configPanel) {
          cargarContenidoConfiguracion(e.target.dataset.configPanel);
        }
      });

      // Formularios de configuración
      dom.congregacionForm?.addEventListener(
        "submit",
        manejarGuardarCongregacion
      );
      dom.btnActualizarTerritorios?.addEventListener(
        "click",
        manejarActualizarTerritorios
      );
      dom.btnGuardarManzanas?.addEventListener(
        "click",
        territoriosManager.guardarConfiguracionManzanas
      );

      // Gestión de usuarios
      dom.btnAddConductor?.addEventListener("click", manejarAgregarConductor);
      dom.btnAddPublicador?.addEventListener("click", manejarAgregarPublicador);

      // Importación y gestión telefónica
      dom.fileImportTelefonos?.addEventListener(
        "change",
        manejarImportacionTelefonos
      );
      dom.btnLimpiarDuplicadosConfig?.addEventListener(
        "click",
        telefonosManager.limpiarDuplicados
      );
      dom.btnExportarTelefonos?.addEventListener(
        "click",
        manejarExportarTelefonos
      );
      dom.btnResetTelefonos?.addEventListener("click", manejarResetTelefonos);

      // Dashboard y administración
      dom.dashboardSearchSelect?.addEventListener(
        "change",
        manejarBusquedaDashboard
      );
      dom.btnExportarS13?.addEventListener("click", () =>
        dom.modalExportarS13.showModal()
      );

      // Conductor
      dom.btnTerritoriosDisponibles?.addEventListener("click", () =>
        dom.modalTerritoriosDisponibles.showModal()
      );
      dom.btnSolicitarNumeros?.addEventListener(
        "click",
        manejarSolicitarNumeros
      );
      dom.btnDescargarListado?.addEventListener(
        "click",
        manejarDescargarListado
      );

      // Modales
      dom.modalMensaje?.addEventListener("click", cerrarModalSiClickAfuera);
      dom.modalConfirmar?.addEventListener("click", cerrarModalSiClickAfuera);
      dom.btnConfirmYes?.addEventListener("click", () => {
        estadoApp.confirmCallback?.();
        dom.modalConfirmar.close();
      });
      dom.btnConfirmNo?.addEventListener("click", () =>
        dom.modalConfirmar.close()
      );

      // Territorios dinámicos
      document.addEventListener("click", manejarClickTerritorios);
      document.addEventListener("change", manejarCambiosManzanas);
    }

    function cambiarModo(modo) {
      // Ocultar todas las vistas
      document
        .querySelectorAll(".view")
        .forEach((view) => (view.style.display = "none"));

      // Actualizar estado
      estadoApp.modoActual = modo;

      // Mostrar vista correspondiente
      switch (modo) {
        case "conductor":
          dom.viewConductor.style.display = "block";
          navegarConductor("asignaciones");
          break;
        case "administrador":
          dom.viewAdministrador.style.display = "block";
          navegarAdministrador("dashboard");
          actualizarDashboard();
          break;
        case "configuracion":
          dom.viewConfiguracion.style.display = "block";
          navegarConfiguracion("congregacion");
          break;
      }

      // Actualizar botones activos
      document
        .querySelectorAll(".mode-btn")
        .forEach((btn) => btn.classList.remove("active"));
      document.querySelector(`[onclick*="${modo}"]`)?.classList.add("active");
    }

    function navegarConfiguracion(panel) {
      // Actualizar navegación
      document
        .querySelectorAll("#viewConfiguracion .nav-btn")
        .forEach((btn) => btn.classList.remove("active"));
      document
        .querySelector(`[data-panel="${panel}"]`)
        ?.classList.add("active");

      // Mostrar panel
      mostrarPanelConfiguracion(panel);
      estadoApp.panelActivo = panel;
    }

    function navegarAdministrador(panel) {
      // Actualizar navegación dinámica según el rol
      actualizarNavegacionAdmin();

      document
        .querySelectorAll("#viewAdministrador .nav-btn")
        .forEach((btn) => btn.classList.remove("active"));
      document
        .querySelector(`#viewAdministrador [data-panel="${panel}"]`)
        ?.classList.add("active");

      mostrarPanelAdministrador(panel);
      estadoApp.panelActivo = panel;
    }

    function actualizarNavegacionAdmin() {
      const nav = dom.adminNav;
      if (!nav) return;

      let navButtons = `
            <button class="tab active" data-panel="dashboard">Dashboard</button>
            <button class="tab" data-panel="programar-territorio">Programar</button>
            <button class="tab" data-panel="programa-admin">Programa</button>
            <button class="tab" data-panel="reportes">Reportes</button>
        `;

      // Agregar opciones adicionales para SuperAdmin
      if (estadoApp.isSuperAdmin) {
        navButtons += `
                <button class="tab" data-panel="usuarios">Usuarios</button>
                <button class="tab" data-panel="sistema">Sistema</button>
                <button class="tab" data-panel="configuracion-avanzada">Config Avanzada</button>
            `;
      }

      nav.innerHTML = navButtons;

      // Reattach event listeners
      nav.querySelectorAll(".tab").forEach((btn) => {
        btn.onclick = () => navegarAdministrador(btn.dataset.panel);
      });
    }

    function navegarConductor(panel) {
      document
        .querySelectorAll("#viewConductor .nav-btn")
        .forEach((btn) => btn.classList.remove("active"));
      document
        .querySelector(`#viewConductor [data-panel="${panel}"]`)
        ?.classList.add("active");

      mostrarPanelConductor(panel);
      estadoApp.panelActivo = panel;
    }

    // FUNCIONES DE MANEJO DE EVENTOS
    async function manejarGuardarCongregacion(e) {
      e.preventDefault();

      const datos = {
        nombre: dom.configCongregacionNombre.value.trim(),
        ciudad: dom.configCongregacionCiudad.value.trim(),
        pais: dom.configCongregacionPais.value.trim(),
        coordinador: dom.configCoordinador.value.trim(),
      };

      if (!datos.nombre) {
        utils.showMessage("El nombre de la congregación es requerido");
        return;
      }

      await configuracionManager.actualizarCongregacion(datos);
      utils.showNotification("Información de la congregación guardada");
    }

    async function manejarActualizarTerritorios() {
      const nuevoTotal = parseInt(dom.configTotalTerritorios.value);

      if (nuevoTotal < 1 || nuevoTotal > 50) {
        utils.showMessage("El número de territorios debe estar entre 1 y 50");
        return;
      }

      const manzanasDefault = {};
      for (let i = 1; i <= nuevoTotal; i++) {
        manzanasDefault[i] =
          estadoApp.configuracion.territorios.manzanasPorTerritorio[i] || 1;
      }

      await configuracionManager.actualizarTerritorios(
        nuevoTotal,
        manzanasDefault
      );
      utils.showNotification(
        `Configuración actualizada a ${nuevoTotal} territorios`
      );
    }

    async function manejarAgregarConductor() {
      const nombre = dom.configNuevoConductor.value.trim();

      if (!nombre) {
        utils.showMessage("Ingresa el nombre del conductor");
        return;
      }

      const conductor = {
        id: utils.generateId(),
        nombre,
        fechaIngreso: new Date(),
        activo: true,
      };

      try {
        await setDoc(firestore.conductorDoc(conductor.id), conductor);
        dom.configNuevoConductor.value = "";
        utils.showNotification("Conductor agregado");
        actualizarListaConductores();
      } catch (error) {
        console.error("Error agregando conductor:", error);
        utils.showNotification("Error al agregar conductor", "error");
      }
    }

    async function manejarAgregarPublicador() {
      const nombre = dom.configNuevoPublicador.value.trim();

      if (!nombre) {
        utils.showMessage("Ingresa el nombre del publicador");
        return;
      }

      const publicador = {
        id: utils.generateId(),
        nombre,
        fechaIngreso: new Date(),
        activo: true,
      };

      try {
        await setDoc(firestore.publicadorDoc(publicador.id), publicador);
        dom.configNuevoPublicador.value = "";
        utils.showNotification("Publicador agregado");
        actualizarListaPublicadores();
      } catch (error) {
        console.error("Error agregando publicador:", error);
        utils.showNotification("Error al agregar publicador", "error");
      }
    }

    async function manejarImportacionTelefonos(e) {
      const file = e.target.files[0];
      if (!file) return;

      utils.showNotification("Importando registros...", "warning");

      try {
        const registrosImportados = await telefonosManager.importarCSV(file);
        utils.showNotification(
          `${registrosImportados} registros importados correctamente`
        );
        telefonosManager.renderTablaConfig();
      } catch (error) {
        console.error("Error importando:", error);
        utils.showNotification("Error al importar el archivo", "error");
      }

      e.target.value = "";
    }

    async function manejarExportarTelefonos() {
      const ws = XLSX.utils.json_to_sheet(
        estadoApp.listadoTelefonico.map((r) => ({
          Nombre: r.nombre,
          Direccion: r.direccion,
          Telefono: r.telefono,
          Estado: r.estado,
          Comentarios: r.comentarios,
        }))
      );

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Listado Telefónico");
      XLSX.writeFile(wb, `listado-telefonico-${utils.todayISO()}.xlsx`);

      utils.showNotification("Listado exportado");
    }

    async function manejarResetTelefonos() {
      const confirmacion = await new Promise((resolve) => {
        utils.showConfirmation(
          "¿Estás seguro de eliminar TODOS los registros telefónicos? Esta acción no se puede deshacer.",
          () => resolve(true)
        );
        dom.btnConfirmNo.onclick = () => resolve(false);
      });

      if (confirmacion) {
        utils.showNotification("Eliminando registros...", "warning");

        try {
          const batch = writeBatch(db);
          estadoApp.listadoTelefonico.forEach((registro) => {
            batch.delete(firestore.telefonoDoc(registro.id));
          });
          await batch.commit();

          utils.showNotification("Todos los registros han sido eliminados");
        } catch (error) {
          console.error("Error eliminando registros:", error);
          utils.showNotification("Error al eliminar registros", "error");
        }
      }
    }

    function manejarBusquedaDashboard(e) {
      const territorioSeleccionado = e.target.value;

      if (territorioSeleccionado) {
        dom.chartTitle.textContent = `Cobertura del Territorio ${territorioSeleccionado}`;
        mostrarCoberturaIndividual(territorioSeleccionado);
      } else {
        dom.chartTitle.textContent = "Cobertura General de Territorios";
        mostrarCoberturaGeneral();
      }
    }

    function manejarClickTerritorios(e) {
      if (e.target.hasAttribute("data-terr")) {
        const territorio = e.target.dataset.terr;
        seleccionarTerritorio(territorio);
      }

      if (e.target.hasAttribute("data-manzana")) {
        const manzana = e.target.dataset.manzana;
        seleccionarManzana(manzana);
      }
    }

    function manejarCambiosManzanas(e) {
      if (e.target.classList.contains("manzanas-input")) {
        const territorio = e.target.dataset.territorio;
        const manzanas = parseInt(e.target.value) || 1;

        estadoApp.configuracion.territorios.manzanasPorTerritorio[territorio] =
          manzanas;
      }
    }

    function cerrarModalSiClickAfuera(e) {
      if (e.target === e.currentTarget) {
        e.target.close();
      }
    }

    // FUNCIONES DE RENDERIZADO DE PANELES
    function mostrarPanelConfiguracion(panel) {
      const panels = {
        congregacion: renderConfiguracionCongregacion,
        territorios: renderConfiguracionTerritorios,
        usuarios: renderConfiguracionUsuarios,
        telefonos: renderConfiguracionTelefonos,
        sistema: renderConfiguracionSistema,
      };

      const renderFunc = panels[panel];
      if (renderFunc) {
        renderFunc();
      }
    }

    function mostrarPanelAdministrador(panel) {
      document
        .querySelectorAll("#admin-content > div")
        .forEach((div) => div.classList.add("hidden"));
      const targetPanel = document.getElementById(`panel-${panel}`);

      if (panel === "configuracion") {
        // Panel de configuración - Solo SuperAdmin
        if (estadoApp.isSuperAdmin) {
          targetPanel?.classList.remove("hidden");
          cargarContenidoConfiguracion("congregacion"); // Cargar el primer sub-panel
        } else {
          utils.showNotification(
            "Acceso denegado: Solo SuperAdmin puede acceder a la configuración",
            "error"
          );
          return;
        }
      } else {
        // Otros paneles normales
        const panels = {
          dashboard: actualizarDashboard,
          "programar-territorio": renderAdminTerritorios,
          "programa-admin": renderAdminPrograma,
          reportes: renderAdminEstado,
          territorios: renderAdminTerritorios,
          programa: renderAdminPrograma,
          estado: renderAdminEstado,
          telefonos: renderAdminTelefonos,
          // Paneles exclusivos de SuperAdmin
          usuarios: estadoApp.isSuperAdmin ? renderSuperAdminUsuarios : null,
          sistema: estadoApp.isSuperAdmin ? renderSuperAdminSistema : null,
          "configuracion-avanzada": estadoApp.isSuperAdmin
            ? renderSuperAdminConfigAvanzada
            : null,
        };

        targetPanel?.classList.remove("hidden");
        const renderFunc = panels[panel];
        if (renderFunc) {
          renderFunc();
        } else if (estadoApp.isSuperAdmin) {
          // Funcionalidad exclusiva para SuperAdmin
          renderPanelSuperAdmin(panel);
        }
      }
    }

    function mostrarPanelConductor(panel) {
      const panels = {
        asignaciones: renderConductorAsignaciones,
        telefonos: renderConductorTelefonos,
        programa: renderConductorPrograma,
      };

      const renderFunc = panels[panel];
      if (renderFunc) {
        renderFunc();
      }
    }

    // Función para cargar contenido de configuración
    function cargarContenidoConfiguracion(panel) {
      const configContentAdmin = document.getElementById(
        "config-content-admin"
      );
      if (!configContentAdmin) return;

      // Actualizar navegación activa
      document
        .querySelectorAll("[data-config-panel]")
        .forEach((btn) => btn.classList.remove("active"));
      document
        .querySelector(`[data-config-panel="${panel}"]`)
        ?.classList.add("active");

      const paneles = {
        congregacion: renderConfiguracionCongregacion,
        "territorios-config": renderConfiguracionTerritorios,
        "usuarios-config": renderConfiguracionUsuarios,
        "telefonos-config": renderConfiguracionTelefonos,
        "sistema-config": renderConfiguracionSistema,
      };

      const renderFunc = paneles[panel];
      if (renderFunc) {
        // Cargar el contenido en el contenedor de configuración del admin
        const originalConfigContent = dom.configContent;
        dom.configContent = configContentAdmin; // Temporalmente cambiar el target
        renderFunc();
        dom.configContent = originalConfigContent; // Restaurar
      }
    }

    // RENDERIZADO ESPECÍFICO DE PANELES
    function renderConfiguracionCongregacion() {
      dom.configContent.innerHTML = `
            <div class="config-panel">
                <h3>Información de la Congregación</h3>
                <form id="congregacion-form" class="form">
                    <div class="form-group">
                        <label for="config-congregacion-nombre">Nombre de la Congregación *</label>
                        <input type="text" id="config-congregacion-nombre" required 
                               value="${estadoApp.configuracion.congregacion.nombre}" 
                               placeholder="Ej: Congregación Centro">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="config-congregacion-ciudad">Ciudad</label>
                            <input type="text" id="config-congregacion-ciudad" 
                                   value="${estadoApp.configuracion.congregacion.ciudad}"
                                   placeholder="Ej: Madrid">
                        </div>
                        <div class="form-group">
                            <label for="config-congregacion-pais">País</label>
                            <input type="text" id="config-congregacion-pais" 
                                   value="${estadoApp.configuracion.congregacion.pais}"
                                   placeholder="Ej: España">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="config-coordinador">Coordinador de Cuerpo de Ancianos</label>
                        <input type="text" id="config-coordinador" 
                               value="${estadoApp.configuracion.congregacion.coordinador}"
                               placeholder="Nombre del coordinador">
                    </div>
                    
                    <button type="submit" class="btn primary">Guardar Información</button>
                </form>
            </div>
        `;

      // Reconfigurar eventos
      document
        .getElementById("congregacion-form")
        .addEventListener("submit", manejarGuardarCongregacion);
    }

    function renderConfiguracionTerritorios() {
      dom.configContent.innerHTML = `
            <div class="config-panel">
                <h3>Configuración de Territorios</h3>
                
                <div class="form-group">
                    <label for="config-total-territorios">Número Total de Territorios</label>
                    <div class="input-group">
                        <input type="number" id="config-total-territorios" min="1" max="50" 
                               value="${
                                 estadoApp.configuracion.territorios.total
                               }">
                        <button type="button" id="btnActualizarTerritorios" class="btn secondary">
                            Actualizar
                        </button>
                    </div>
                    <small>Cambiará la estructura general de territorios</small>
                </div>
                
                <div id="territorios-preview" class="territorios-grid">
                    ${Array.from(
                      { length: estadoApp.configuracion.territorios.total },
                      (_, i) =>
                        `<div class="territorio-preview">T${i + 1}</div>`
                    ).join("")}
                </div>
                
                <h4>Manzanas por Territorio</h4>
                <div id="manzanas-config-container" class="manzanas-config-grid">
                    ${Object.entries(
                      estadoApp.configuracion.territorios.manzanasPorTerritorio
                    )
                      .map(
                        ([territorio, manzanas]) => `
                            <div class="config-territorio-item">
                                <label for="manzanas-t${territorio}">T${territorio}</label>
                                <input type="number" id="manzanas-t${territorio}" min="1" max="20" 
                                       value="${manzanas}" data-territorio="${territorio}" 
                                       class="manzanas-input">
                            </div>
                        `
                      )
                      .join("")}
                </div>
                
                <button type="button" id="btnGuardarManzanas" class="btn primary">
                    Guardar Configuración de Manzanas
                </button>
            </div>
        `;

      // Reconfigurar eventos
      document
        .getElementById("btnActualizarTerritorios")
        .addEventListener("click", manejarActualizarTerritorios);
      document
        .getElementById("btnGuardarManzanas")
        .addEventListener(
          "click",
          territoriosManager.guardarConfiguracionManzanas
        );
    }

    function renderConfiguracionUsuarios() {
      dom.configContent.innerHTML = `
            <div class="config-panel">
                <div class="usuarios-section">
                    <h3>Conductores</h3>
                    <div class="input-group">
                        <input type="text" id="config-nuevo-conductor" placeholder="Nombre del conductor">
                        <button type="button" id="btnAddConductor" class="btn secondary">Agregar</button>
                    </div>
                    <div id="config-conductores-list" class="usuarios-list"></div>
                </div>
                
                <div class="usuarios-section">
                    <h3>Publicadores</h3>
                    <div class="input-group">
                        <input type="text" id="config-nuevo-publicador" placeholder="Nombre del publicador">
                        <button type="button" id="btnAddPublicador" class="btn secondary">Agregar</button>
                    </div>
                    <div id="config-publicadores-list" class="usuarios-list"></div>
                </div>
            </div>
        `;

      // Reconfigurar eventos
      document
        .getElementById("btnAddConductor")
        .addEventListener("click", manejarAgregarConductor);
      document
        .getElementById("btnAddPublicador")
        .addEventListener("click", manejarAgregarPublicador);

      // Cargar listas
      actualizarListaConductores();
      actualizarListaPublicadores();
    }

    function renderConfiguracionTelefonos() {
      dom.configContent.innerHTML = `
            <div class="config-panel">
                <h3>Gestión de Base Telefónica</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-registros">0</div>
                        <div class="stat-label">Total Registros</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="registros-activos">0</div>
                        <div class="stat-label">Activos</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value" id="registros-duplicados">0</div>
                        <div class="stat-label">Duplicados</div>
                    </div>
                </div>
                
                <div class="telefonos-actions">
                    <div class="upload-zone" id="import-telefonos-zone">
                        <input type="file" id="file-import-telefonos" accept=".csv,.xlsx,.xls" style="display: none;">
                        <label for="file-import-telefonos" class="btn secondary">
                            📂 Importar CSV/Excel
                        </label>
                    </div>
                    
                    <button type="button" id="btnAddRegistroManual" class="btn secondary">
                        ➕ Agregar Manual
                    </button>
                    
                    <button type="button" id="btnLimpiarDuplicadosConfig" class="btn warn">
                        🧹 Limpiar Duplicados
                    </button>
                    
                    <button type="button" id="btnExportarTelefonos" class="btn primary">
                        📤 Exportar Excel
                    </button>
                    
                    <button type="button" id="btnResetTelefonos" class="btn err">
                        🗑️ Eliminar Todo
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="tabla-telefonos-config" class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Dirección</th>
                                <th>Teléfono</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-telefonos-config"></tbody>
                    </table>
                </div>
                
                <div class="pagination">
                    <button id="btnPrevPageConfig" class="btn-sm btn secondary">Anterior</button>
                    <span id="pageIndicatorConfig">Página 1 de 1</span>
                    <button id="btnNextPageConfig" class="btn-sm btn secondary">Siguiente</button>
                </div>
            </div>
        `;

      // Reconfigurar eventos
      document
        .getElementById("file-import-telefonos")
        .addEventListener("change", manejarImportacionTelefonos);
      document
        .getElementById("btnLimpiarDuplicadosConfig")
        .addEventListener("click", telefonosManager.limpiarDuplicados);
      document
        .getElementById("btnExportarTelefonos")
        .addEventListener("click", manejarExportarTelefonos);
      document
        .getElementById("btnResetTelefonos")
        .addEventListener("click", manejarResetTelefonos);

      // Renderizar datos
      telefonosManager.renderTablaConfig();
    }

    function renderConfiguracionSistema() {
      dom.configContent.innerHTML = `
            <div class="config-panel">
                <h3>Configuración del Sistema</h3>
                
                <div class="system-section">
                    <h4>Análisis Inteligente</h4>
                    <p>Ejecuta análisis automático para detectar problemas y optimizaciones.</p>
                    <button type="button" onclick="sistemaIA.ejecutarAnalisisCompleto()" class="btn primary">
                        🤖 Ejecutar Análisis IA
                    </button>
                    <div id="sugerencias-ia" class="ai-suggestions"></div>
                </div>
                
                <div class="system-section">
                    <h4>Estados Telefónicos Personalizados</h4>
                    <div class="estados-list">
                        ${estadoApp.configuracion.estadosTelefonicos
                          .map(
                            (estado) => `
                            <span class="estado-tag">${
                              estado || "Sin estado"
                            }</span>
                        `
                          )
                          .join("")}
                    </div>
                </div>
                
                <div class="system-section">
                    <h4>Lugares de Reunión</h4>
                    <div class="lugares-list">
                        ${estadoApp.configuracion.lugares
                          .map(
                            (lugar) => `
                            <span class="lugar-tag">${lugar}</span>
                        `
                          )
                          .join("")}
                    </div>
                </div>
                
                <div class="system-section">
                    <h4>Facetas de Ministerio</h4>
                    <div class="facetas-list">
                        ${estadoApp.configuracion.facetas
                          .map(
                            (faceta) => `
                            <span class="faceta-tag">${faceta}</span>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            </div>
        `;
    }

    // RENDERIZADO DE ADMINISTRADOR
    function actualizarDashboard() {
      // Calcular KPIs
      const totalTerritorios = estadoApp.configuracion.territorios.total;
      const asignados = Object.values(estadoApp.territorios).filter((t) =>
        t?.asignaciones?.some((a) => a.estado === "activo")
      ).length;
      const completados = Object.values(estadoApp.territorios).filter((t) =>
        t?.historialAsignaciones?.some((h) => h.fechaDevolucion)
      ).length;
      const progreso =
        totalTerritorios > 0
          ? Math.round((completados / totalTerritorios) * 100)
          : 0;
      const conductoresActivos = estadoApp.conductores.filter(
        (c) => c.activo
      ).length;

      // Actualizar KPIs
      if (dom.kpiAsignados) dom.kpiAsignados.textContent = asignados;
      if (dom.kpiCompletados) dom.kpiCompletados.textContent = completados;
      if (dom.kpiProgreso) dom.kpiProgreso.textContent = `${progreso}%`;
      if (dom.kpiConductoresActivos)
        dom.kpiConductoresActivos.textContent = conductoresActivos;

      // Mostrar gráfico
      mostrarCoberturaGeneral();
    }

    function mostrarCoberturaGeneral() {
      const ctx = dom.territoryCoverageChart?.getContext("2d");
      if (!ctx) return;

      if (estadoApp.coverageChart) {
        estadoApp.coverageChart.destroy();
      }

      const data = [];
      const labels = [];

      for (let i = 1; i <= estadoApp.configuracion.territorios.total; i++) {
        labels.push(`T${i}`);
        const territorio = estadoApp.territorios[i];
        const progreso = territorio?.historialAsignaciones?.length || 0;
        data.push(progreso);
      }

      estadoApp.coverageChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Veces Completado",
              data,
              backgroundColor: "rgba(79, 70, 229, 0.6)",
              borderColor: "rgba(79, 70, 229, 1)",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false,
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
              },
            },
          },
        },
      });
    }

    function mostrarCoberturaIndividual(territorioId) {
      const territorio = estadoApp.territorios[territorioId];
      if (!territorio) return;

      const ctx = dom.territoryCoverageChart?.getContext("2d");
      if (!ctx) return;

      if (estadoApp.coverageChart) {
        estadoApp.coverageChart.destroy();
      }

      const manzanas =
        estadoApp.configuracion.territorios.manzanasPorTerritorio[
          territorioId
        ] || 1;
      const labels = Array.from({ length: manzanas }, (_, i) => `M${i + 1}`);
      const data = Array.from({ length: manzanas }, () =>
        Math.floor(Math.random() * 5)
      ); // Simulado

      estadoApp.coverageChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: [
                "#4F46E5",
                "#10B981",
                "#F59E0B",
                "#EF4444",
                "#8B5CF6",
                "#06B6D4",
              ],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom",
            },
          },
        },
      });
    }

    // FUNCIONES DE UTILIDAD PARA ACTUALIZACIÓN DE LISTAS
    async function actualizarListaConductores() {
      const container = document.getElementById("config-conductores-list");
      if (!container) return;

      const html = estadoApp.conductores
        .map(
          (conductor) => `
            <div class="usuario-item">
                <span>${conductor.nombre}</span>
                <button onclick="eliminarConductor('${conductor.id}')" class="btn-sm btn err">
                    Eliminar
                </button>
            </div>
        `
        )
        .join("");

      container.innerHTML = html;
    }

    async function actualizarListaPublicadores() {
      const container = document.getElementById("config-publicadores-list");
      if (!container) return;

      const html = estadoApp.publicadores
        .map(
          (publicador) => `
            <div class="usuario-item">
                <span>${publicador.nombre}</span>
                <button onclick="eliminarPublicador('${publicador.id}')" class="btn-sm btn err">
                    Eliminar
                </button>
            </div>
        `
        )
        .join("");

      container.innerHTML = html;
    }

    // FUNCIONES GLOBALES PARA EVENTOS INLINE
    window.eliminarConductor = async function (id) {
      const confirmacion = await new Promise((resolve) => {
        utils.showConfirmation(
          "¿Estás seguro de eliminar este conductor?",
          () => resolve(true)
        );
        dom.btnConfirmNo.onclick = () => resolve(false);
      });

      if (confirmacion) {
        await deleteDoc(firestore.conductorDoc(id));
        utils.showNotification("Conductor eliminado");
        actualizarListaConductores();
      }
    };

    window.eliminarPublicador = async function (id) {
      const confirmacion = await new Promise((resolve) => {
        utils.showConfirmation(
          "¿Estás seguro de eliminar este publicador?",
          () => resolve(true)
        );
        dom.btnConfirmNo.onclick = () => resolve(false);
      });

      if (confirmación) {
        await deleteDoc(firestore.publicadorDoc(id));
        utils.showNotification("Publicador eliminado");
        actualizarListaPublicadores();
      }
    };

    // FUNCIONES DE VERIFICACIÓN DE ACCESO
    function verificarAccesoAdmin() {
      dom.modalPassword.showModal();
      dom.passwordForm.onsubmit = (e) => {
        e.preventDefault();
        const phone = dom.adminPhone.value.trim();
        const password = dom.passwordInput.value;

        // Verificar credenciales Super Admin
        if (phone === SUPER_ADMIN.phone && password === SUPER_ADMIN.password) {
          estadoApp.currentUser = {
            phone: phone,
            role: "superadmin",
            nombre: "Super Administrador",
          };
          estadoApp.currentUserRole = "superadmin";
          estadoApp.isAdministrador = true;
          estadoApp.isSuperAdmin = true;

          dom.modalPassword.close();
          dom.adminPhone.value = "";
          dom.passwordInput.value = "";
          dom.passwordError.style.display = "none";

          utils.showNotification(
            "✅ Super Admin autenticado correctamente",
            "success"
          );
          cambiarModo("administrador");
          return;
        }

        // Verificar admin normal
        if (password === "admin123") {
          estadoApp.currentUser = {
            role: "admin",
            nombre: "Administrador",
          };
          estadoApp.currentUserRole = "admin";
          estadoApp.isAdministrador = true;
          estadoApp.isSuperAdmin = false;

          dom.modalPassword.close();
          dom.adminPhone.value = "";
          dom.passwordInput.value = "";
          dom.passwordError.style.display = "none";

          utils.showNotification(
            "✅ Administrador autenticado correctamente",
            "success"
          );
          cambiarModo("administrador");
        } else {
          dom.passwordError.style.display = "block";
          dom.adminPhone.value = "";
          dom.passwordInput.value = "";
        }
      };
    }

    function verificarAccesoConfiguracion() {
      dom.modalPassword.showModal();
      dom.passwordForm.onsubmit = (e) => {
        e.preventDefault();
        const password = dom.passwordInput.value;

        if (password === "config456") {
          dom.modalPassword.close();
          dom.passwordInput.value = "";
          dom.passwordError.style.display = "none";
          cambiarModo("configuracion");
        } else {
          dom.passwordError.style.display = "block";
          dom.passwordInput.value = "";
        }
      };
    }

    // FUNCIONES DE CONDUCTOR
    function renderConductorAsignaciones() {
      const conductorSeleccionado = dom.conductorVista?.value;
      let asignacionesHTML = "";

      if (conductorSeleccionado) {
        const asignacionesActivas = [];

        // Buscar asignaciones activas del conductor
        Object.entries(estadoApp.territorios).forEach(
          ([territorioId, territorio]) => {
            const asignacionesDelTerritorio =
              territorio.asignaciones?.filter(
                (a) =>
                  a.conductor === conductorSeleccionado && a.estado === "activo"
              ) || [];

            asignacionesDelTerritorio.forEach((asignacion) => {
              asignacionesActivas.push({
                territorioId,
                ...asignacion,
                manzanasTotales:
                  estadoApp.configuracion.territorios.manzanasPorTerritorio[
                    territorioId
                  ] || 1,
                manzanasCompletadas:
                  asignacion.manzanasCompletadas?.length || 0,
              });
            });
          }
        );

        if (asignacionesActivas.length > 0) {
          asignacionesHTML = asignacionesActivas
            .map((asignacion) => {
              const progreso =
                asignacion.manzanasTotales > 0
                  ? Math.round(
                      (asignacion.manzanasCompletadas /
                        asignacion.manzanasTotales) *
                        100
                    )
                  : 0;

              return `
                        <div class="asignacion-card">
                            <div class="asignacion-header">
                                <h4>Territorio ${asignacion.territorioId}</h4>
                                <span class="progress-badge">${progreso}%</span>
                            </div>
                            <p><strong>Asignado:</strong> ${
                              asignacion.fechaAsignacion
                            }</p>
                            <p><strong>Publicador:</strong> ${
                              asignacion.publicador || "Sin asignar"
                            }</p>
                            <p><strong>Progreso:</strong> ${
                              asignacion.manzanasCompletadas
                            } de ${asignacion.manzanasTotales} manzanas</p>
                            
                            <div class="manzanas-progress">
                                ${Array.from(
                                  { length: asignacion.manzanasTotales },
                                  (_, i) => {
                                    const manzanaNum = i + 1;
                                    const completada =
                                      asignacion.manzanasCompletadas?.some(
                                        (m) => m.numero === manzanaNum
                                      );
                                    return `
                                        <button class="manzana-btn ${
                                          completada ? "completed" : ""
                                        }" 
                                                onclick="marcarManzanaCompletada('${
                                                  asignacion.territorioId
                                                }', '${
                                      asignacion.id
                                    }', ${manzanaNum})"
                                                title="${
                                                  completada
                                                    ? "Completada"
                                                    : "Pendiente"
                                                }">
                                            M${manzanaNum}
                                        </button>
                                    `;
                                  }
                                ).join("")}
                            </div>
                            
                            <div class="asignacion-actions">
                                <button class="btn secondary" onclick="verDetallesTerritorio('${
                                  asignacion.territorioId
                                }')">
                                    Ver Detalles
                                </button>
                                <button class="btn warn" onclick="mostrarModalDevolver('${
                                  asignacion.territorioId
                                }', '${asignacion.id}')">
                                    Devolver
                                </button>
                            </div>
                        </div>
                    `;
            })
            .join("");
        } else {
          asignacionesHTML = `
                    <div class="no-asignaciones">
                        <p>No tienes territorios asignados actualmente.</p>
                        <button class="btn primary" onclick="dom.modalTerritoriosDisponibles.showModal()">
                            Ver Territorios Disponibles
                        </button>
                    </div>
                `;
        }
      } else {
        asignacionesHTML = `
                <div class="seleccionar-conductor">
                    <p>Selecciona tu nombre para ver tus asignaciones.</p>
                </div>
            `;
      }

      dom.conductorContent.innerHTML = `
            <div class="conductor-panel">
                <div class="conductor-header">
                    <h3>Mis Asignaciones</h3>
                    <div class="conductor-selector">
                        <label for="conductorVista">Mi nombre:</label>
                        <select id="conductorVista" onchange="renderConductorAsignaciones()">
                            <option value="">Seleccionar conductor</option>
                            ${estadoApp.conductores
                              .map(
                                (c) => `
                                <option value="${c.nombre}" ${
                                  dom.conductorVista?.value === c.nombre
                                    ? "selected"
                                    : ""
                                }>${c.nombre}</option>
                            `
                              )
                              .join("")}
                        </select>
                    </div>
                </div>
                
                <div class="asignaciones-container">
                    ${asignacionesHTML}
                </div>
                
                <div class="conductor-actions">
                    <button class="btn primary" onclick="dom.modalTerritoriosDisponibles.showModal()">
                        Ver Territorios Disponibles
                    </button>
                    <button class="btn secondary" onclick="mostrarHistorialConductor('${conductorSeleccionado}')">
                        Mi Historial
                    </button>
                </div>
            </div>
        `;

      // Actualizar modal de territorios disponibles
      actualizarModalTerritoriosDisponibles();
    }

    function mostrarModalDevolver(territorioId, asignacionId) {
      document.getElementById("devolverTerritorioId").value = territorioId;
      document.getElementById("devolverAsignacionIndex").value = asignacionId;
      document.getElementById(
        "devolverInfoTerritorio"
      ).textContent = `Territorio ${territorioId}`;
      document.getElementById("devolverFecha").value = utils.todayISO();
      dom.modalDevolver.showModal();
    }

    function actualizarModalTerritoriosDisponibles() {
      const tbody = document.getElementById("tbodyTerritoriosDisponibles");
      if (!tbody) return;

      const territoriosDisponibles = [];
      Object.entries(estadoApp.territorios).forEach(([id, territorio]) => {
        if (
          territorio.estado !== "asignado" ||
          !territorio.asignaciones?.some((a) => a.estado === "activo")
        ) {
          const ultimaVez =
            territorio.historialAsignaciones?.length > 0
              ? territorio.historialAsignaciones[
                  territorio.historialAsignaciones.length - 1
                ].fechaDevolucion
              : "Nunca completado";

          const manzanas =
            estadoApp.configuracion.territorios.manzanasPorTerritorio[id] || 1;
          const mesesSinAsignar =
            ultimaVez !== "Nunca completado"
              ? Math.floor(
                  (new Date() - new Date(ultimaVez)) /
                    (1000 * 60 * 60 * 24 * 30)
                )
              : 999;

          let prioridad = "Baja";
          if (mesesSinAsignar > 6) prioridad = "Alta";
          else if (mesesSinAsignar > 3) prioridad = "Media";

          territoriosDisponibles.push({
            id,
            manzanas,
            ultimaVez: ultimaVez === "Nunca completado" ? ultimaVez : ultimaVez,
            prioridad,
            mesesSinAsignar,
          });
        }
      });

      // Ordenar por prioridad
      territoriosDisponibles.sort(
        (a, b) => b.mesesSinAsignar - a.mesesSinAsignar
      );

      const html = territoriosDisponibles
        .map(
          (t) => `
            <tr>
                <td>
                    <strong>Territorio ${t.id}</strong>
                    <button class="btn-sm btn primary ml-2" onclick="solicitarTerritorio('${
                      t.id
                    }')">
                        Solicitar
                    </button>
                </td>
                <td>${t.manzanas}</td>
                <td>${t.ultimaVez}</td>
                <td>
                    <span class="priority-badge ${t.prioridad.toLowerCase()}">${
            t.prioridad
          }</span>
                </td>
            </tr>
        `
        )
        .join("");

      tbody.innerHTML = html;
    }

    async function solicitarTerritorio(territorioId) {
      const conductor = dom.conductorVista?.value;
      if (!conductor) {
        utils.showMessage("Selecciona tu nombre primero");
        return;
      }

      const confirmacion = await new Promise((resolve) => {
        utils.showConfirmation(
          `¿Solicitar asignación del Territorio ${territorioId}?`,
          () => resolve(true)
        );
        dom.btnConfirmNo.onclick = () => resolve(false);
      });

      if (confirmacion) {
        await asignarTerritorio(territorioId, conductor);
        dom.modalTerritoriosDisponibles.close();
      }
    }

    function verDetallesTerritorio(territorioId) {
      const territorio = estadoApp.territorios[territorioId];
      const manzanas =
        estadoApp.configuracion.territorios.manzanasPorTerritorio[
          territorioId
        ] || 1;

      const historialHTML =
        territorio.historialAsignaciones
          ?.map(
            (h) => `
            <div class="historial-item">
                <strong>${h.conductor}</strong> ${
              h.publicador ? `(con ${h.publicador})` : ""
            }
                <br>
                <small>${h.fechaAsignacion} - ${h.fechaDevolucion}</small>
                <br>
                <small>${h.comentarios || "Sin comentarios"}</small>
            </div>
        `
          )
          .join("") || "<p>Sin historial previo</p>";

      dom.historialTitulo.textContent = `Detalles del Territorio ${territorioId}`;
      dom.historialBody.innerHTML = `
            <div class="territorio-detalles">
                <h4>Información General</h4>
                <p><strong>Territorio:</strong> ${territorioId}</p>
                <p><strong>Manzanas:</strong> ${manzanas}</p>
                <p><strong>Estado:</strong> ${
                  territorio.estado || "Disponible"
                }</p>
                
                <h4>Historial de Asignaciones</h4>
                <div class="historial-container">
                    ${historialHTML}
                </div>
            </div>
        `;

      dom.modalHistorial.showModal();
    }

    function mostrarHistorialConductor(conductor) {
      if (!conductor) {
        utils.showMessage("Selecciona tu nombre primero");
        return;
      }

      const historial = [];
      Object.entries(estadoApp.territorios).forEach(
        ([territorioId, territorio]) => {
          territorio.historialAsignaciones?.forEach((h) => {
            if (h.conductor === conductor) {
              historial.push({ territorioId, ...h });
            }
          });
        }
      );

      historial.sort(
        (a, b) => new Date(b.fechaDevolucion) - new Date(a.fechaDevolucion)
      );

      const historialHTML =
        historial.length > 0
          ? historial
              .map(
                (h) => `
            <div class="historial-item">
                <strong>Territorio ${h.territorioId}</strong>
                ${h.publicador ? `(con ${h.publicador})` : ""}
                <br>
                <small>${h.fechaAsignacion} - ${h.fechaDevolucion}</small>
                <br>
                <small>Manzanas completadas: ${
                  h.manzanasCompletadas?.length || 0
                }</small>
                <br>
                <small>${h.comentarios || "Sin comentarios"}</small>
            </div>
        `
              )
              .join("")
          : "<p>No hay historial disponible</p>";

      dom.historialTitulo.textContent = `Historial de ${conductor}`;
      dom.historialBody.innerHTML = `
            <div class="conductor-historial">
                <h4>Territorios Completados</h4>
                <div class="historial-container">
                    ${historialHTML}
                </div>
            </div>
        `;

      dom.modalHistorial.showModal();
    }

    // Funciones globales adicionales
    window.solicitarTerritorio = solicitarTerritorio;
    window.verDetallesTerritorio = verDetallesTerritorio;
    window.mostrarHistorialConductor = mostrarHistorialConductor;
    window.mostrarModalDevolver = mostrarModalDevolver;

    function renderConductorTelefonos() {
      dom.conductorContent.innerHTML = `
            <div class="conductor-panel">
                <h3>Listado Telefónico</h3>
                <div class="telefonos-actions">
                    <button id="btnSolicitarNumeros" class="btn primary">
                        Solicitar Números
                    </button>
                    <button id="btnDescargarListado" class="btn secondary">
                        Descargar mi Listado
                    </button>
                </div>
                
                <div id="telefonos-loading" class="loading" style="display: none;">
                    Cargando listado telefónico...
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Dirección</th>
                                <th>Teléfono</th>
                                <th>Estado</th>
                                <th>Comentarios</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-telefonica"></tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function renderConductorPrograma() {
      dom.conductorContent.innerHTML = `
            <div class="conductor-panel">
                <h3>Programa de Predicación</h3>
                <div id="programa-view-container">
                    <div class="programa-semana">
                        <h4>Esta Semana</h4>
                        <div class="programa-items">
                            <div class="programa-item">
                                <span class="fecha">15 Oct 2024</span>
                                <span class="territorio">Territorio 5</span>
                                <span class="lugar">Salón del Reino</span>
                                <span class="faceta">Casa en casa</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // FUNCIONES ADMINISTRATIVAS ADICIONALES
    function renderAdminTerritorios() {
      dom.adminContent.innerHTML = `
            <div class="admin-panel">
                <h3>Gestión de Territorios</h3>
                
                <div id="territorios-dinamicos" class="territorios-grid">
                    ${Array.from(
                      { length: estadoApp.configuracion.territorios.total },
                      (_, i) =>
                        `<button data-terr="${i + 1}" class="territorio-btn">${
                          i + 1
                        }</button>`
                    ).join("")}
                </div>
                
                <div class="territorio-details" style="display: none;">
                    <h4>Detalles del Territorio</h4>
                    <div id="manzanasListaAdmin"></div>
                    <div id="manzanas-actions-container">
                        <button id="btnSelTodas" class="btn secondary">Seleccionar Todas</button>
                        <button id="btnLimpiarSel" class="btn secondary">Limpiar Selección</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderAdminPrograma() {
      dom.adminContent.innerHTML = `
            <div class="admin-panel">
                <h3>Programa de Predicación</h3>
                
                <form id="programa-form" class="form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="programa-fecha">Fecha</label>
                            <input type="date" id="programa-fecha" required>
                        </div>
                        <div class="form-group">
                            <label for="programa-territorio">Territorio</label>
                            <select id="programa-territorio" required>
                                <option value="">Seleccionar territorio</option>
                                ${Array.from(
                                  {
                                    length:
                                      estadoApp.configuracion.territorios.total,
                                  },
                                  (_, i) =>
                                    `<option value="${i + 1}">Territorio ${
                                      i + 1
                                    }</option>`
                                ).join("")}
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn primary">Agregar al Programa</button>
                </form>
                
                <div class="programa-lista">
                    <!-- Aquí se mostrarían los elementos del programa -->
                </div>
            </div>
        `;
    }

    function renderAdminEstado() {
      dom.adminContent.innerHTML = `
            <div class="admin-panel">
                <h3>Estado General</h3>
                
                <div class="export-section">
                    <button id="btnExportarS13" class="btn primary">
                        📋 Exportar S-13
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Territorio</th>
                                <th>Estado</th>
                                <th>Conductor</th>
                                <th>Fecha Asignación</th>
                                <th>Último Reporte</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-estado-general">
                            ${Array.from(
                              {
                                length:
                                  estadoApp.configuracion.territorios.total,
                              },
                              (_, i) => {
                                const territorio = estadoApp.territorios[i + 1];
                                return `
                                    <tr>
                                        <td>Territorio ${i + 1}</td>
                                        <td>${
                                          territorio?.estado || "Disponible"
                                        }</td>
                                        <td>${
                                          territorio?.conductorActual || "-"
                                        }</td>
                                        <td>${
                                          territorio?.fechaAsignacion || "-"
                                        }</td>
                                        <td>${
                                          territorio?.ultimoReporte || "-"
                                        }</td>
                                    </tr>
                                `;
                              }
                            ).join("")}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function renderAdminTelefonos() {
      dom.adminContent.innerHTML = `
            <div class="admin-panel">
                <h3>Administración Telefónica</h3>
                
                <div class="admin-telefonos-stats">
                    <div class="stat-card">
                        <div class="stat-value">${
                          estadoApp.listadoTelefonico.length
                        }</div>
                        <div class="stat-label">Total Registros</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${
                          estadoApp.listadoTelefonico.filter(
                            (r) => r.estado === "Contestaron"
                          ).length
                        }</div>
                        <div class="stat-label">Contestaron</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value">${
                          estadoApp.listadoTelefonico.filter(
                            (r) => r.estado === "No llamar"
                          ).length
                        }</div>
                        <div class="stat-label">No Llamar</div>
                    </div>
                </div>
                
                <div class="telefonos-management">
                    <button onclick="sistemaIA.ejecutarAnalisisCompleto()" class="btn primary">
                        🤖 Análisis Automático
                    </button>
                </div>
            </div>
        `;
    }

    // FUNCIONES DE UTILIDAD PARA EVENTOS ADICIONALES
    async function manejarSolicitarNumeros() {
      utils.showMessage("Función de solicitud de números en desarrollo");
    }

    async function manejarDescargarListado() {
      utils.showMessage("Función de descarga en desarrollo");
    }

    function seleccionarTerritorio(territorio) {
      // Toggle selección
      if (estadoApp.territoriosSeleccionados.has(territorio)) {
        estadoApp.territoriosSeleccionados.delete(territorio);
      } else {
        estadoApp.territoriosSeleccionados.add(territorio);
      }

      // Actualizar UI
      actualizarSeleccionTerritorios();
    }

    function seleccionarManzana(manzana) {
      if (estadoApp.manzanasSeleccionadas.has(manzana)) {
        estadoApp.manzanasSeleccionadas.delete(manzana);
      } else {
        estadoApp.manzanasSeleccionadas.add(manzana);
      }

      actualizarSeleccionManzanas();
    }

    function actualizarSeleccionTerritorios() {
      document.querySelectorAll(".territorio-btn").forEach((btn) => {
        const territorio = btn.dataset.terr;
        if (estadoApp.territoriosSeleccionados.has(territorio)) {
          btn.classList.add("selected");
        } else {
          btn.classList.remove("selected");
        }
      });
    }

    function actualizarSeleccionManzanas() {
      document.querySelectorAll("[data-manzana]").forEach((btn) => {
        const manzana = btn.dataset.manzana;
        if (estadoApp.manzanasSeleccionadas.has(manzana)) {
          btn.classList.add("selected");
        } else {
          btn.classList.remove("selected");
        }
      });
    }

    // FUNCIONES DE CARGA DE DATOS
    async function cargarDatos() {
      try {
        // Cargar configuración
        await configuracionManager.cargarConfiguracion();

        // Cargar conductores (simulado por ahora)
        estadoApp.conductores = [
          { id: "1", nombre: "Juan Pérez", activo: true },
          { id: "2", nombre: "María García", activo: true },
          { id: "3", nombre: "Carlos López", activo: true },
        ];

        // Cargar publicadores (simulado por ahora)
        estadoApp.publicadores = [
          { id: "1", nombre: "Ana Martín", activo: true },
          { id: "2", nombre: "Luis Fernández", activo: true },
        ];

        // Cargar territorios (simulado por ahora)
        estadoApp.territorios = {};
        for (let i = 1; i <= estadoApp.configuracion.territorios.total; i++) {
          estadoApp.territorios[i] = {
            id: i,
            estado: Math.random() > 0.7 ? "asignado" : "disponible",
            asignaciones: [],
            historialAsignaciones: [],
          };
        }

        // Cargar teléfonos (simulado por ahora)
        estadoApp.listadoTelefonico = [
          {
            id: "1",
            nombre: "Pedro Ruiz",
            direccion: "Calle Mayor 123",
            telefono: "912345678",
            estado: "Contestaron",
            comentarios: "",
          },
          {
            id: "2",
            nombre: "Carmen Vega",
            direccion: "Avenida Central 45",
            telefono: "987654321",
            estado: "No contestaron",
            comentarios: "",
          },
        ];

        // Generar elementos dinámicos
        territoriosManager.generarTerritoriosDinamicos();
        territoriosManager.generarConfiguracionManzanas();
      } catch (error) {
        console.error("Error cargando datos:", error);
        utils.showNotification("Error cargando datos del sistema", "error");
      }
    }

    // INICIALIZACIÓN PRINCIPAL
    async function inicializar() {
      try {
        // Configurar login expandible
        configurarLoginExpandible();

        // Autenticación Firebase
        await signInWithCustomToken(auth, "demo-token").catch(() =>
          console.log("Usando modo demo sin autenticación")
        );

        // Cargar datos
        await cargarDatos();

        // Mostrar login screen
        mostrarPantallaLogin();
      } catch (error) {
        console.error("Error en inicialización:", error);
        utils.showNotification("Error inicializando el sistema", "error");
      }
    }

    // Configurar funcionalidad del login expandible
    function configurarLoginExpandible() {
      // Manejar clics en opciones de login
      document.addEventListener("click", (e) => {
        const header = e.target.closest(".option-header");
        if (header) {
          const option = header.dataset.option;
          toggleLoginOption(option);
        }
      });

      // Manejar formulario de administrador
      const adminForm = document.getElementById("adminLoginForm");
      if (adminForm) {
        adminForm.addEventListener("submit", handleAdminLogin);
      }

      // Manejar toggle de contraseña
      const togglePassword = document.getElementById("toggleAdminPassword");
      if (togglePassword) {
        togglePassword.addEventListener("click", () => {
          const passwordInput = document.getElementById("adminPassword");
          const eyeIcon = document.getElementById("adminEyeIcon");

          if (passwordInput.type === "password") {
            passwordInput.type = "text";
            eyeIcon.innerHTML = `
                        <path d="m15 18-.722-3.25"/>
                        <path d="M2 8a10.645 10.645 0 0 0 20 0"/>
                        <path d="m20 15-1.726-2.05"/>
                        <path d="m4 15 1.726-2.05"/>
                        <path d="m9 10 3 3 3-3"/>
                    `;
          } else {
            passwordInput.type = "password";
            eyeIcon.innerHTML = `
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    `;
          }
        });
      }

      // Cargar lista de conductores para la opción conductor
      cargarListaConductores();
    }

    function toggleLoginOption(option) {
      const adminOption = document.getElementById("admin-option");
      const conductorOption = document.getElementById("conductor-option");
      const adminForm = document.getElementById("admin-form");
      const conductorForm = document.getElementById("conductor-form");

      // Resetear ambas opciones
      adminOption.classList.remove("active");
      conductorOption.classList.remove("active");
      adminForm.classList.add("hidden");
      conductorForm.classList.add("hidden");

      // Activar la opción seleccionada
      if (option === "admin") {
        adminOption.classList.add("active");
        adminForm.classList.remove("hidden");
      } else if (option === "conductor") {
        conductorOption.classList.add("active");
        conductorForm.classList.remove("hidden");
      }
    }

    async function handleAdminLogin(e) {
      e.preventDefault();

      const phone = document.getElementById("adminPhone").value;
      const password = document.getElementById("adminPassword").value;
      const errorDiv = document.getElementById("adminError");
      const submitBtn = document.getElementById("adminLoginBtn");

      // Limpiar errores
      errorDiv.classList.add("hidden");
      errorDiv.textContent = "";

      // Validación básica
      if (!phone || !password) {
        mostrarErrorLogin("Por favor, completa todos los campos");
        return;
      }

      // Deshabilitar botón
      submitBtn.disabled = true;
      submitBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 11-6.219-8.56"/>
            </svg>
            Verificando...
        `;

      try {
        // Verificar credenciales
        const esValido = await verificarCredencialesAdmin(phone, password);

        if (esValido) {
          // Login exitoso
          ocultarPantallaLogin();
          configurarModoAdmin();
          utils.showNotification(
            "Acceso autorizado como Administrador",
            "success"
          );
        } else {
          mostrarErrorLogin("Credenciales incorrectas");
        }
      } catch (error) {
        console.error("Error en login:", error);
        mostrarErrorLogin("Error de conexión. Intenta nuevamente.");
      } finally {
        // Rehabilitar botón
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m9 18 6-6-6-6"/>
                </svg>
                Acceder como Administrador
            `;
      }
    }

    function mostrarErrorLogin(mensaje) {
      const errorDiv = document.getElementById("adminError");
      errorDiv.textContent = mensaje;
      errorDiv.classList.remove("hidden");
    }

    async function cargarListaConductores() {
      const conductorList = document.getElementById("conductorList");
      if (!conductorList) return;

      try {
        // Obtener lista de conductores desde Firestore o datos locales
        const conductores = data.conductores || [];

        conductorList.innerHTML = "";

        if (conductores.length === 0) {
          conductorList.innerHTML = `
                    <div class="text-center" style="padding: 2rem; color: #64748b;">
                        <p>No hay conductores disponibles</p>
                    </div>
                `;
          return;
        }

        conductores.forEach((conductor) => {
          const conductorItem = document.createElement("div");
          conductorItem.className = "conductor-item";
          conductorItem.dataset.conductorId = conductor.id;

          const iniciales = conductor.nombre
            .split(" ")
            .map((n) => n[0])
            .join("")
            .toUpperCase();

          conductorItem.innerHTML = `
                    <div class="conductor-avatar">${iniciales}</div>
                    <div class="conductor-info">
                        <div class="conductor-name">${conductor.nombre}</div>
                        <div class="conductor-details">Activo desde ${
                          conductor.fechaIngreso || "N/A"
                        }</div>
                    </div>
                `;

          conductorItem.addEventListener("click", () => {
            seleccionarConductor(conductor);
          });

          conductorList.appendChild(conductorItem);
        });
      } catch (error) {
        console.error("Error cargando conductores:", error);
        conductorList.innerHTML = `
                <div class="text-center" style="padding: 2rem; color: #ef4444;">
                    <p>Error cargando lista de conductores</p>
                </div>
            `;
      }
    }

    function seleccionarConductor(conductor) {
      // Remover selección previa
      document.querySelectorAll(".conductor-item").forEach((item) => {
        item.classList.remove("selected");
      });

      // Seleccionar conductor actual
      const conductorItem = document.querySelector(
        `[data-conductor-id="${conductor.id}"]`
      );
      if (conductorItem) {
        conductorItem.classList.add("selected");
      }

      // Proceder con login de conductor
      setTimeout(() => {
        ocultarPantallaLogin();
        configurarModoConductor(conductor);
        utils.showNotification(`Bienvenido, ${conductor.nombre}`, "success");
      }, 300);
    }

    function mostrarPantallaLogin() {
      const loginScreen = document.getElementById("login-screen");
      const appContainer = document.getElementById("app-container");

      if (loginScreen) {
        loginScreen.style.display = "flex";
      }
      if (appContainer) {
        appContainer.classList.add("hidden");
      }
    }

    function ocultarPantallaLogin() {
      const loginScreen = document.getElementById("login-screen");
      const appContainer = document.getElementById("app-container");

      if (loginScreen) {
        loginScreen.style.display = "none";
      }
      if (appContainer) {
        appContainer.classList.remove("hidden");
        appContainer.style.display = "block";
      }
    }

    async function verificarCredencialesAdmin(phone, password) {
      // Aquí implementarías la lógica real de verificación
      // Por ahora, usar credenciales de demo
      const adminCredentials = [
        { phone: "0994749286", password: "admin123" },
        { phone: "0987654321", password: "admin456" },
      ];

      return adminCredentials.some(
        (cred) => cred.phone === phone && cred.password === password
      );
    }

    function configurarModoAdmin() {
      // Configurar eventos de navegación para admin
      configurarEventosNavegacion();
      // Cambiar al modo administrador
      cambiarModo("administrador");
    }

    function configurarModoConductor(conductor) {
      // Establecer conductor activo
      window.conductorActivo = conductor;
      // Configurar eventos de navegación para conductor
      configurarEventosNavegacion();
      // Cambiar al modo conductor
      cambiarModo("conductor");
    }

    // FUNCIONES PRINCIPALES DE GESTIÓN DE TERRITORIOS
    async function asignarTerritorio(
      territorioId,
      conductor,
      publicador = null,
      fecha = null
    ) {
      try {
        const fechaAsignacion = fecha || utils.todayISO();
        const asignacion = {
          id: utils.generateId(),
          territorioId,
          conductor,
          publicador,
          fechaAsignacion,
          fechaDevolucion: null,
          estado: "activo",
          manzanasAsignadas: [],
          comentarios: "",
        };

        // Actualizar en Firebase
        await setDoc(firestore.territorioDoc(territorioId), {
          ...estadoApp.territorios[territorioId],
          asignaciones: [
            ...(estadoApp.territorios[territorioId]?.asignaciones || []),
            asignacion,
          ],
          estado: "asignado",
          conductorActual: conductor,
          fechaUltimaAsignacion: fechaAsignacion,
        });

        // Actualizar estado local
        if (!estadoApp.territorios[territorioId]) {
          estadoApp.territorios[territorioId] = {
            id: territorioId,
            asignaciones: [],
          };
        }
        estadoApp.territorios[territorioId].asignaciones =
          estadoApp.territorios[territorioId].asignaciones || [];
        estadoApp.territorios[territorioId].asignaciones.push(asignacion);
        estadoApp.territorios[territorioId].estado = "asignado";
        estadoApp.territorios[territorioId].conductorActual = conductor;

        utils.showNotification(
          `Territorio ${territorioId} asignado a ${conductor}`
        );
        actualizarDashboard();
        renderConductorAsignaciones();

        return asignacion;
      } catch (error) {
        console.error("Error asignando territorio:", error);
        utils.showNotification("Error al asignar territorio", "error");
      }
    }

    async function devolverTerritorio(
      territorioId,
      asignacionId,
      fechaDevolucion = null,
      comentarios = ""
    ) {
      try {
        const territorio = estadoApp.territorios[territorioId];
        if (!territorio || !territorio.asignaciones) {
          throw new Error("Territorio no encontrado");
        }

        const asignacionIndex = territorio.asignaciones.findIndex(
          (a) => a.id === asignacionId
        );
        if (asignacionIndex === -1) {
          throw new Error("Asignación no encontrada");
        }

        const fechaFinal = fechaDevolucion || utils.todayISO();
        const asignacion = territorio.asignaciones[asignacionIndex];

        // Actualizar asignación
        asignacion.fechaDevolucion = fechaFinal;
        asignacion.estado = "completado";
        asignacion.comentarios = comentarios;

        // Mover al historial
        if (!territorio.historialAsignaciones) {
          territorio.historialAsignaciones = [];
        }
        territorio.historialAsignaciones.push({ ...asignacion });

        // Remover de asignaciones activas
        territorio.asignaciones.splice(asignacionIndex, 1);

        // Si no hay más asignaciones activas, marcar como disponible
        if (territorio.asignaciones.length === 0) {
          territorio.estado = "disponible";
          territorio.conductorActual = null;
        }

        // Guardar en Firebase
        await setDoc(firestore.territorioDoc(territorioId), territorio);

        utils.showNotification(
          `Territorio ${territorioId} devuelto correctamente`
        );
        actualizarDashboard();
        renderConductorAsignaciones();

        return true;
      } catch (error) {
        console.error("Error devolviendo territorio:", error);
        utils.showNotification("Error al devolver territorio", "error");
        return false;
      }
    }

    async function marcarManzanaCompletada(
      territorioId,
      asignacionId,
      manzana
    ) {
      try {
        const territorio = estadoApp.territorios[territorioId];
        const asignacion = territorio?.asignaciones?.find(
          (a) => a.id === asignacionId
        );

        if (!asignacion) {
          throw new Error("Asignación no encontrada");
        }

        if (!asignacion.manzanasCompletadas) {
          asignacion.manzanasCompletadas = [];
        }

        // Toggle completado
        const manzanaIndex = asignacion.manzanasCompletadas.findIndex(
          (m) => m.numero === manzana
        );
        if (manzanaIndex >= 0) {
          asignacion.manzanasCompletadas.splice(manzanaIndex, 1);
        } else {
          asignacion.manzanasCompletadas.push({
            numero: manzana,
            fechaCompletado: utils.todayISO(),
            observaciones: "",
          });
        }

        // Guardar en Firebase
        await setDoc(firestore.territorioDoc(territorioId), territorio);

        utils.showNotification(
          `Manzana ${manzana} ${
            manzanaIndex >= 0 ? "desmarcada" : "completada"
          }`
        );
        renderConductorAsignaciones();

        return true;
      } catch (error) {
        console.error("Error marcando manzana:", error);
        utils.showNotification("Error al actualizar manzana", "error");
        return false;
      }
    }

    async function exportarS13(fechaInicio, fechaFin, incluirDetalles = false) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Configurar fuente
        doc.setFont("helvetica");

        // Título
        doc.setFontSize(16);
        doc.text(
          "Registro S-13 - Registro de Territorio de Congregación",
          20,
          20
        );

        // Información de la congregación
        doc.setFontSize(12);
        const congregacion = estadoApp.configuracion.congregacion;
        doc.text(`Congregación: ${congregacion.nombre}`, 20, 35);
        doc.text(
          `Ciudad: ${congregacion.ciudad}, ${congregacion.pais}`,
          20,
          45
        );
        doc.text(`Período: ${fechaInicio} - ${fechaFin}`, 20, 55);

        // Preparar datos
        const territoriosData = [];
        Object.entries(estadoApp.territorios).forEach(([id, territorio]) => {
          const historial = territorio.historialAsignaciones || [];
          const asignacionesEnPeriodo = historial.filter((h) => {
            const fechaDev = new Date(h.fechaDevolucion);
            const inicio = new Date(fechaInicio);
            const fin = new Date(fechaFin);
            return fechaDev >= inicio && fechaDev <= fin;
          });

          if (asignacionesEnPeriodo.length > 0) {
            asignacionesEnPeriodo.forEach((asig) => {
              territoriosData.push([
                `T${id}`,
                asig.conductor,
                asig.publicador || "-",
                asig.fechaAsignacion,
                asig.fechaDevolucion,
                asig.manzanasCompletadas?.length || 0,
                asig.comentarios || "-",
              ]);
            });
          }
        });

        // Tabla con autoTable
        doc.autoTable({
          head: [
            [
              "Territorio",
              "Conductor",
              "Publicador",
              "Fecha Asign.",
              "Fecha Devolución",
              "Manzanas",
              "Observaciones",
            ],
          ],
          body: territoriosData,
          startY: 70,
          styles: { fontSize: 8 },
          headStyles: { fillColor: [79, 70, 229] },
        });

        // Descargar
        doc.save(`S13-${fechaInicio}-${fechaFin}.pdf`);
        utils.showNotification("Reporte S-13 generado correctamente");
      } catch (error) {
        console.error("Error generando S-13:", error);
        utils.showNotification("Error al generar reporte S-13", "error");
      }
    }

    async function actualizarEstadoTelefono(
      registroId,
      nuevoEstado,
      comentarios = ""
    ) {
      try {
        const registro = estadoApp.listadoTelefonico.find(
          (r) => r.id === registroId
        );
        if (!registro) {
          throw new Error("Registro no encontrado");
        }

        registro.estado = nuevoEstado;
        registro.comentarios = comentarios;
        registro.fechaUltimaActualizacion = new Date();

        // Guardar en Firebase
        await setDoc(firestore.telefonoDoc(registroId), registro);

        utils.showNotification("Estado actualizado correctamente");
        telefonosManager.renderTablaConfig();

        return true;
      } catch (error) {
        console.error("Error actualizando estado:", error);
        utils.showNotification("Error al actualizar estado", "error");
        return false;
      }
    }

    async function solicitudNumerosTerritoriales(conductor, cantidad = 10) {
      try {
        // Obtener números disponibles
        const disponibles = estadoApp.listadoTelefonico
          .filter((r) => !r.asignadoA && r.estado !== "No llamar")
          .slice(0, cantidad);

        if (disponibles.length === 0) {
          utils.showNotification("No hay números disponibles", "warning");
          return [];
        }

        // Asignar números
        const batch = writeBatch(db);
        const numerosAsignados = [];

        disponibles.forEach((registro) => {
          registro.asignadoA = conductor;
          registro.fechaAsignacion = new Date();
          batch.set(firestore.telefonoDoc(registro.id), registro);
          numerosAsignados.push(registro);
        });

        await batch.commit();

        utils.showNotification(
          `${numerosAsignados.length} números asignados a ${conductor}`
        );
        return numerosAsignados;
      } catch (error) {
        console.error("Error asignando números:", error);
        utils.showNotification("Error al asignar números", "error");
        return [];
      }
    }

    // FUNCIONES GLOBALES ADICIONALES PARA EVENTOS
    window.asignarTerritorio = asignarTerritorio;
    window.devolverTerritorio = devolverTerritorio;
    window.marcarManzanaCompletada = marcarManzanaCompletada;
    window.exportarS13 = exportarS13;
    window.actualizarEstadoTelefono = actualizarEstadoTelefono;
    window.solicitudNumerosTerritoriales = solicitudNumerosTerritoriales;

    // Configurar eventos para modales específicos
    function configurarEventosAdicionales() {
      // Modal devolver territorio
      dom.devolverForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const territorioId = document.getElementById(
          "devolverTerritorioId"
        )?.value;
        const asignacionId = document.getElementById(
          "devolverAsignacionIndex"
        )?.value;
        const fecha = document.getElementById("devolverFecha")?.value;
        const comentarios = document.getElementById(
          "devolverComentarios"
        )?.value;

        if (territorioId && asignacionId) {
          const success = await devolverTerritorio(
            territorioId,
            asignacionId,
            fecha,
            comentarios
          );
          if (success) {
            dom.modalDevolver?.close();
            e.target.reset();
          }
        }
      });

      // Modal exportar S-13
      document
        .getElementById("exportS13Form")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const fechaInicio = document.getElementById("exportStartDate")?.value;
          const fechaFin = document.getElementById("exportEndDate")?.value;
          const incluirDetalles =
            document.getElementById("incluirDetalles")?.checked;

          if (fechaInicio && fechaFin) {
            await exportarS13(fechaInicio, fechaFin, incluirDetalles);
            dom.modalExportarS13?.close();
          }
        });

      // Actualizar eventos de botones de solicitud
      dom.btnSolicitarNumeros?.addEventListener("click", async () => {
        const conductor = dom.conductorVista?.value;
        if (conductor) {
          const numeros = await solicitudNumerosTerritoriales(conductor);
          if (numeros.length > 0) {
            renderTelefonosConductor(numeros);
          }
        } else {
          utils.showMessage("Selecciona tu nombre primero");
        }
      });

      // Configurar drag & drop para importación
      dom.importTelefonosZone?.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.target.classList.add("dragover");
      });

      dom.importTelefonosZone?.addEventListener("dragleave", (e) => {
        e.target.classList.remove("dragover");
      });

      dom.importTelefonosZone?.addEventListener("drop", async (e) => {
        e.preventDefault();
        e.target.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          if (
            file.name.endsWith(".csv") ||
            file.name.endsWith(".xlsx") ||
            file.name.endsWith(".xls")
          ) {
            try {
              const registros = await telefonosManager.importarCSV(file);
              utils.showNotification(`${registros} registros importados`);
              telefonosManager.renderTablaConfig();
            } catch (error) {
              utils.showNotification("Error al importar archivo", "error");
            }
          } else {
            utils.showNotification(
              "Formato de archivo no soportado",
              "warning"
            );
          }
        }
      });
    }

    function renderTelefonosConductor(telefonos) {
      if (!dom.tbodyTelefonica) return;

      const html = telefonos
        .map(
          (telefono) => `
            <tr>
                <td class="name-cell">${telefono.nombre}</td>
                <td class="address-cell">${telefono.direccion}</td>
                <td>${telefono.telefono}</td>
                <td>${telefono.asignadoA || "-"}</td>
                <td>
                    <select onchange="actualizarEstadoTelefono('${
                      telefono.id
                    }', this.value)">
                        <option value="">Seleccionar...</option>
                        ${estadoApp.configuracion.estadosTelefonicos
                          .map(
                            (estado) =>
                              `<option value="${estado}" ${
                                telefono.estado === estado ? "selected" : ""
                              }>${estado}</option>`
                          )
                          .join("")}
                    </select>
                </td>
                <td class="comments-cell">${telefono.comentarios}</td>
            </tr>
        `
        )
        .join("");

      dom.tbodyTelefonica.innerHTML = html;
      dom.telefonosLoading.style.display = "none";
    }

    // EJECUTAR CUANDO EL DOM ESTÉ LISTO
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", () => {
        inicializar();
        configurarEventosAdicionales();
      });
    } else {
      inicializar();
      configurarEventosAdicionales();
    }
  </script>

  <!-- Estilos Adicionales -->
  <style>
    /* Notificaciones */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 10000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      max-width: 400px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .notification.error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .notification.warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    /* Estados de territorios con nueva paleta profesional */
    .territorio-btn.selected {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--text-inverse);
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }

    .territorio-btn.asignado {
      background: linear-gradient(135deg, var(--warning), var(--warning-dark));
      color: var(--gray-900);
      border-color: var(--warning);
    }

    .territorio-btn.completado {
      background: linear-gradient(135deg, var(--success), var(--success-dark));
      color: var(--text-inverse);
      border-color: var(--success);
    }

    .territorio-btn.disponible {
      background: var(--bg-primary);
      color: var(--text-secondary);
      border-color: var(--gray-300);
    }

    .territorio-btn.vencido {
      background: linear-gradient(135deg, var(--error), var(--error-dark));
      color: var(--text-inverse);
      border-color: var(--error);
    }

    /* Análisis IA */
    .ai-analysis-results {
      margin-top: 20px;
      border-top: 1px solid var(--stroke);
      padding-top: 20px;
    }

    .ai-suggestion {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary);
      background: rgba(79, 70, 229, 0.05);
    }

    .ai-suggestion.warning {
      border-left-color: #f59e0b;
      background: rgba(245, 158, 11, 0.05);
    }

    .ai-suggestion.error {
      border-left-color: #ef4444;
      background: rgba(239, 68, 68, 0.05);
    }

    .ai-suggestion.success {
      border-left-color: #10b981;
      background: rgba(16, 185, 129, 0.05);
    }

    .ai-suggestion ul {
      margin-top: 10px;
      padding-left: 20px;
    }

    /* Usuarios */
    .usuario-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border: 1px solid var(--stroke);
      border-radius: 6px;
      margin-bottom: 8px;
      background: var(--surface);
    }

    .usuarios-section {
      margin-bottom: 40px;
    }

    .usuarios-list {
      max-height: 300px;
      overflow-y: auto;
    }

    /* Estadísticas telefónicas */
    .admin-telefonos-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .telefonos-management {
      text-align: center;
      margin: 30px 0;
    }

    /* Configuración de manzanas */
    .manzanas-config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 15px;
      margin: 20px 0;
      padding: 20px;
      background: var(--surface);
      border-radius: 12px;
      border: 1px solid var(--stroke);
    }

    .config-territorio-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .config-territorio-item label {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.9rem;
    }

    .manzanas-input {
      width: 60px;
      text-align: center;
      padding: 8px;
      border: 1px solid var(--stroke);
      border-radius: 6px;
      background: var(--background);
    }

    /* Preview de territorios */
    .territorios-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }

    .territorio-preview {
      aspect-ratio: 1;
      background: linear-gradient(135deg, var(--surface), var(--background));
      border: 1px solid var(--stroke);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--primary);
      font-size: 0.9rem;
    }

    /* Tags de configuración */
    .estado-tag,
    .lugar-tag,
    .faceta-tag {
      display: inline-block;
      padding: 6px 12px;
      margin: 4px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .estado-tag {
      background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
      color: #3730a3;
    }

    .lugar-tag {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      color: #166534;
    }

    .faceta-tag {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e;
    }

    /* Error message */
    .error-message {
      text-align: center;
      color: var(--text-color);
    }

    .error-message h3 {
      color: #ef4444;
      margin-bottom: 10px;
    }

    /* Conductor Panel Styles */
    .conductor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .conductor-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .conductor-selector label {
      margin: 0;
      font-weight: 600;
      color: var(--accent-2);
    }

    .conductor-selector select {
      min-width: 200px;
    }

    .asignaciones-container {
      display: grid;
      gap: 20px;
      margin-bottom: 24px;
    }

    .asignacion-card {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 20px;
      transition: transform 0.2s;
    }

    .asignacion-card:hover {
      transform: translateY(-2px);
    }

    .asignacion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .asignacion-header h4 {
      margin: 0;
      color: var(--accent-2);
      font-size: 1.3rem;
    }

    .progress-badge {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0b1020;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .manzanas-progress {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 16px 0;
      padding: 16px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .manzana-btn {
      width: 40px;
      height: 40px;
      border: 2px solid var(--stroke);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .manzana-btn:hover {
      border-color: var(--accent-2);
      background: rgba(96, 165, 250, 0.2);
    }

    .manzana-btn.completed {
      background: linear-gradient(135deg, var(--ok), #10b981);
      border-color: var(--ok);
      color: #06221a;
    }

    .asignacion-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .no-asignaciones {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .seleccionar-conductor {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .conductor-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Priority badges */
    .priority-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .priority-badge.alta {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .priority-badge.media {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .priority-badge.baja {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    /* Historial styles */
    .historial-container {
      max-height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .historial-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--stroke);
      border-radius: 8px;
      padding: 12px;
      font-size: 0.9rem;
    }

    .territorio-detalles {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Drag and drop styles */
    .import-zone.dragover {
      border-color: var(--accent);
      background: rgba(167, 139, 250, 0.1);
      transform: scale(1.02);
    }

    /* Button variants */
    .btn-sm {
      padding: 4px 8px;
      font-size: 0.75rem;
      border-radius: 6px;
    }

    .ml-2 {
      margin-left: 8px;
    }

    /* Data table improvements */
    .data-table th {
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(4px);
      z-index: 2;
    }

    .data-table td {
      padding: 12px 8px;
      vertical-align: top;
    }

    /* Form improvements */
    .form-group {
      margin-bottom: 16px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .input-group {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .input-group input {
      flex: 1;
    }

    /* Modal improvements */
    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .manzanas-config-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        padding: 15px;
      }

      .territorios-grid {
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        gap: 8px;
      }

      .notification {
        right: 10px;
        left: 10px;
        max-width: none;
      }

      .conductor-header {
        flex-direction: column;
        align-items: stretch;
      }

      .conductor-selector {
        justify-content: space-between;
      }

      .conductor-selector select {
        min-width: auto;
        flex: 1;
      }

      .asignacion-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .manzanas-progress {
        justify-content: center;
      }

      .asignacion-actions {
        flex-direction: column;
      }

      .conductor-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .input-group {
        flex-direction: column;
        align-items: stretch;
      }
    }

    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      min-width: 300px;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: slideIn 0.3s ease;
    }

    .notification.success {
      background: linear-gradient(
        135deg,
        rgba(34, 197, 94, 0.9),
        rgba(21, 128, 61, 0.9)
      );
    }

    .notification.error {
      background: linear-gradient(
        135deg,
        rgba(239, 68, 68, 0.9),
        rgba(185, 28, 28, 0.9)
      );
    }

    .notification.warning {
      background: linear-gradient(
        135deg,
        rgba(245, 158, 11, 0.9),
        rgba(217, 119, 6, 0.9)
      );
    }

    .notification.info {
      background: linear-gradient(
        135deg,
        rgba(59, 130, 246, 0.9),
        rgba(37, 99, 235, 0.9)
      );
    }

    .notification-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .notification-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    .notification-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* SuperAdmin Styles */
    .super-admin-section {
      background: linear-gradient(
        135deg,
        rgba(167, 139, 250, 0.1),
        rgba(59, 130, 246, 0.1)
      );
      border: 2px solid var(--accent);
      border-radius: 16px;
      padding: 24px;
      margin: 20px 0;
    }

    .users-grid {
      display: grid;
      gap: 16px;
      margin: 20px 0;
    }

    .user-card {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .user-info strong {
      color: var(--accent-2);
      font-size: 1.1rem;
    }

    .user-info span {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .system-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .system-card {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 20px;
    }

    .system-card h4 {
      color: var(--accent-2);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .system-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stats-grid {
      display: grid;
      gap: 12px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-label {
      color: var(--muted);
    }

    .stat-value {
      color: var(--accent-2);
      font-weight: 600;
    }

    .config-sections {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .config-section {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 20px;
    }

    .config-section h4 {
      color: var(--accent-2);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .firebase-status {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .firebase-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .danger-zone {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      padding: 16px;
    }

    .danger-zone p {
      color: #fca5a5;
      margin-bottom: 12px;
    }

    .add-user-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--stroke);
    }

    /* Badge variants */
    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .badge.success {
      background: linear-gradient(135deg, var(--ok), #10b981);
      color: #06221a;
    }

    .badge.warning {
      background: linear-gradient(135deg, var(--warn), #d97706);
      color: #78350f;
    }

    .badge.error {
      background: linear-gradient(135deg, var(--err), #dc2626);
      color: #7f1d1d;
    }

    /* Button variants for SuperAdmin */
    .btn.error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
    }

    .btn.error:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
    }

    .btn.warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      border: none;
    }

    .btn.warning:hover {
      background: linear-gradient(135deg, #d97706, #b45309);
    }
  </style>

  <script>
    // Funciones de notificación y utilidades adicionales
    function showNotification(message, type = "success") {
      const notification = document.createElement("div");
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-content">
            ${message}
            <button onclick="this.parentElement.parentElement.remove()" class="notification-close">×</button>
        </div>
    `;

      document.body.appendChild(notification);

      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 5000);
    }

    // Funciones de estado y progreso
    function updateProgressBadge(
      territoryNum,
      completedManzanas,
      totalManzanas
    ) {
      const percentage = Math.round((completedManzanas / totalManzanas) * 100);
      return `${percentage}% (${completedManzanas}/${totalManzanas})`;
    }

    function getManzanaStatus(territorio, manzanaNum) {
      const asignacion = estadoApp.asignaciones.find(
        (a) => a.territorio === territorio
      );
      if (asignacion && asignacion.manzanasCompletadas.includes(manzanaNum)) {
        return "completed";
      }
      return "";
    }

    // Funciones de validación
    function validateForm(formData) {
      const errors = [];

      if (!formData.nombre || formData.nombre.trim() === "") {
        errors.push("El nombre es obligatorio");
      }

      if (!formData.apellido || formData.apellido.trim() === "") {
        errors.push("El apellido es obligatorio");
      }

      if (!formData.telefono || formData.telefono.trim() === "") {
        errors.push("El teléfono es obligatorio");
      }

      return errors;
    }

    function validateTelefono(telefono) {
      // Validar formato de teléfono (ejemplo: +1234567890 o 1234567890)
      const phoneRegex = /^[\+]?[0-9]{10,15}$/;
      return phoneRegex.test(telefono.replace(/\s+/g, ""));
    }

    // Funciones de formato
    function formatDate(date) {
      if (!date) return "No disponible";

      if (typeof date === "object" && date.seconds) {
        // Firebase Timestamp
        date = new Date(date.seconds * 1000);
      } else if (typeof date === "string") {
        date = new Date(date);
      }

      return date.toLocaleDateString("es-ES", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function formatTelefono(telefono) {
      // Formatear teléfono para mostrar
      const cleaned = telefono.replace(/\D/g, "");
      if (cleaned.length === 10) {
        return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(
          6
        )}`;
      }
      return telefono;
    }

    // Funciones de utilidad
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function sanitizeInput(input) {
      if (typeof input !== "string") return input;
      return input.trim().replace(/[<>]/g, "");
    }

    // Funciones de evento
    function handleKeyPress(event, callback) {
      if (event.key === "Enter") {
        event.preventDefault();
        callback();
      }
    }

    function handleFileSelect(event, callback) {
      const file = event.target.files[0];
      if (file) {
        callback(file);
      }
    }

    // FUNCIONES ESPECÍFICAS DE SUPERADMIN
    function renderSuperAdminUsuarios() {
      dom.adminContent.innerHTML = `
        <div class="admin-panel">
            <h3>🔐 Gestión de Usuarios (SuperAdmin)</h3>
            
            <div class="super-admin-section">
                <h4>Usuarios Administradores</h4>
                <div class="users-grid">
                    <div class="user-card">
                        <div class="user-info">
                            <strong>Super Administrador</strong>
                            <span>Teléfono: ${SUPER_ADMIN.phone}</span>
                            <span>Rol: SuperAdmin</span>
                        </div>
                        <div class="user-actions">
                            <span class="badge success">Activo</span>
                        </div>
                    </div>
                    
                    <div class="user-card">
                        <div class="user-info">
                            <strong>Administrador Local</strong>
                            <span>Contraseña: admin123</span>
                            <span>Rol: Admin</span>
                        </div>
                        <div class="user-actions">
                            <button class="btn secondary btn-sm" onclick="cambiarPasswordAdmin()">Cambiar Password</button>
                        </div>
                    </div>
                </div>
                
                <div class="add-user-section">
                    <h4>Agregar Nuevo Administrador</h4>
                    <form id="form-nuevo-admin" class="form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre</label>
                                <input type="text" id="nuevo-admin-nombre" required>
                            </div>
                            <div class="form-group">
                                <label>Teléfono</label>
                                <input type="tel" id="nuevo-admin-telefono" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Contraseña</label>
                                <input type="password" id="nuevo-admin-password" required>
                            </div>
                            <div class="form-group">
                                <label>Rol</label>
                                <select id="nuevo-admin-rol" required>
                                    <option value="admin">Administrador</option>
                                    <option value="superadmin">Super Administrador</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn primary">Crear Administrador</button>
                    </form>
                </div>
            </div>
        </div>
    `;

      // Configurar formulario
      document.getElementById("form-nuevo-admin").onsubmit = function (e) {
        e.preventDefault();
        crearNuevoAdmin();
      };
    }

    function renderSuperAdminSistema() {
      dom.adminContent.innerHTML = `
        <div class="admin-panel">
            <h3>⚙️ Configuración del Sistema (SuperAdmin)</h3>
            
            <div class="system-grid">
                <div class="system-card">
                    <h4>🔄 Cache y Almacenamiento</h4>
                    <div class="system-actions">
                        <button class="btn warning" onclick="limpiarCacheCompleto()">
                            🗑️ Limpiar Cache Completo
                        </button>
                        <button class="btn secondary" onclick="exportarBaseDatos()">
                            💾 Exportar Base de Datos
                        </button>
                        <button class="btn secondary" onclick="importarBaseDatos()">
                            📁 Importar Base de Datos
                        </button>
                    </div>
                </div>
                
                <div class="system-card">
                    <h4>🔧 Mantenimiento</h4>
                    <div class="system-actions">
                        <button class="btn secondary" onclick="verificarIntegridad()">
                            ✅ Verificar Integridad
                        </button>
                        <button class="btn secondary" onclick="optimizarBaseDatos()">
                            ⚡ Optimizar BD
                        </button>
                        <button class="btn warning" onclick="resetearSistema()">
                            🔄 Reset Sistema
                        </button>
                    </div>
                </div>
                
                <div class="system-card">
                    <h4>📊 Estadísticas del Sistema</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Territorios Totales:</span>
                            <span class="stat-value">${estadoApp.configuracion.territorios.total}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Conductores:</span>
                            <span class="stat-value">${estadoApp.conductores.length}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Registros Telefónicos:</span>
                            <span class="stat-value">${estadoApp.listadoTelefonico.length}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    }

    function renderSuperAdminConfigAvanzada() {
      dom.adminContent.innerHTML = `
        <div class="admin-panel">
            <h3>🛠️ Configuración Avanzada (SuperAdmin)</h3>
            
            <div class="config-sections">
                <div class="config-section">
                    <h4>🔐 Credenciales SuperAdmin</h4>
                    <form class="form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Teléfono SuperAdmin</label>
                                <input type="tel" value="${SUPER_ADMIN.phone}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Nueva Contraseña</label>
                                <input type="password" id="nueva-password-super" placeholder="Nueva contraseña">
                            </div>
                        </div>
                        <button type="button" class="btn warning" onclick="cambiarPasswordSuperAdmin()">
                            Cambiar Contraseña SuperAdmin
                        </button>
                    </form>
                </div>
                
                <div class="config-section">
                    <h4>🌐 Configuración Firebase</h4>
                    <div class="firebase-status">
                        <p><strong>Estado:</strong> <span class="badge success">Conectado</span></p>
                        <p><strong>Proyecto:</strong> conductores-9oct</p>
                        <div class="firebase-actions">
                            <button class="btn secondary" onclick="verificarConexionFirebase()">
                                Verificar Conexión
                            </button>
                            <button class="btn secondary" onclick="sincronizarDatos()">
                                Sincronizar Datos
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h4>⚠️ Zona de Peligro</h4>
                    <div class="danger-zone">
                        <p>Las siguientes acciones son irreversibles:</p>
                        <button class="btn error" onclick="eliminarTodosDatos()">
                            🗑️ Eliminar Todos los Datos
                        </button>
                        <button class="btn error" onclick="resetearConfiguracion()">
                            🔄 Reset Configuración
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    }

    function renderPanelSuperAdmin(panel) {
      // Función genérica para paneles adicionales de SuperAdmin
      dom.adminContent.innerHTML = `
        <div class="admin-panel">
            <h3>🔐 Panel SuperAdmin: ${panel}</h3>
            <p>Funcionalidad exclusiva de SuperAdmin en desarrollo...</p>
        </div>
    `;
    }

    // Funciones de acción para SuperAdmin
    function crearNuevoAdmin() {
      const nombre = document.getElementById("nuevo-admin-nombre").value;
      const telefono = document.getElementById("nuevo-admin-telefono").value;
      const password = document.getElementById("nuevo-admin-password").value;
      const rol = document.getElementById("nuevo-admin-rol").value;

      utils.showNotification(`Admin ${nombre} creado exitosamente`, "success");
      renderSuperAdminUsuarios();
    }

    function cambiarPasswordAdmin() {
      const nuevaPassword = prompt("Nueva contraseña para admin local:");
      if (nuevaPassword) {
        utils.showNotification("Contraseña de admin actualizada", "success");
      }
    }

    function cambiarPasswordSuperAdmin() {
      const nuevaPassword = document.getElementById(
        "nueva-password-super"
      ).value;
      if (nuevaPassword && confirm("¿Cambiar contraseña de SuperAdmin?")) {
        utils.showNotification(
          "Contraseña de SuperAdmin actualizada",
          "warning"
        );
      }
    }

    function limpiarCacheCompleto() {
      if (
        confirm("¿Limpiar todo el cache? Esta acción no se puede deshacer.")
      ) {
        localStorage.clear();
        sessionStorage.clear();
        utils.showNotification("Cache limpiado completamente", "success");
      }
    }

    function exportarBaseDatos() {
      const datos = {
        territorios: estadoApp.territorios,
        conductores: estadoApp.conductores,
        configuracion: estadoApp.configuracion,
        fecha: new Date().toISOString(),
      };

      const blob = new Blob([JSON.stringify(datos, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `backup-sistema-${
        new Date().toISOString().split("T")[0]
      }.json`;
      a.click();

      utils.showNotification("Base de datos exportada", "success");
    }

    function resetearSistema() {
      if (
        confirm("⚠️ ¿RESETEAR TODO EL SISTEMA? Esta acción es IRREVERSIBLE.")
      ) {
        if (confirm("CONFIRMA: ¿Eliminar TODOS los datos y configuración?")) {
          localStorage.clear();
          sessionStorage.clear();
          location.reload();
        }
      }
    }

    // Configuración adicional para funcionalidad completa
    function openConfig() {
      utils.showMessage("Configuración disponible próximamente");
    }

    function closeConfig() {
      const modal = document.getElementById("configModal");
      if (modal) {
        modal.style.display = "none";
      }
    }

    function configureTerritory(number) {
      utils.showMessage(`Configurando territorio ${number}...`);
    }
  </script>
</html>
